// JayData 1.3.4
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
(function(d){function m(a,b){for(var c={constructor:function(){var a=this;a.getEntity().propertyChanged.attach(function(b,c){if(a[c.propertyName]()!==c.newValue)a[c.propertyName](c.newValue)})},retrieveProperty:function(a){var b=this,c=a.name,a="_"+c;b[a]||(koProperty=new ko.observable(b.getEntity()[c]),koProperty.subscribe(function(a){b.getEntity()[c]=a}),b[a]=koProperty);return b[a]},storeProperty:function(){},equalityComparers:{type:d.Object}},g=a.memberDefinitions.getPublicMappedProperties(),
e=0,l=g.length;e<l;e++)propName=g[e].name,c[propName]={type:ko.observable},c.ValidationErrors={type:ko.observable};d.Class.defineEx(b,[{type:d.KoObservableEntity,params:[new ConstructorParameter(0),function(){return a}]}],null,c,{isWrappedType:function(b){return b===a}})}Object.keys(d.Container.converters.to).forEach(function(a){var b=d.Container.converters.to[a]?d.Container.converters.to[a]["$data.Function"]||d.Container.converters.to[a]["default"]:void 0;d.Container.registerConverter(a,"$data.Function",
function(c){if(ko.isObservable(c))return c;if(b)return b.apply(d.Container.converters[a],arguments);Guard.raise(new Exception("Type Error","value is not koObservable",c))})});if("undefined"!==typeof ko){var n=function(){for(var a=3,b=document.createElement("div"),c=b.getElementsByTagName("i");b.innerHTML="<\!--[if gt IE "+ ++a+"]><i></i><![endif]--\>",c[0];);return 4<a?a:void 0}();ko.utils.ensureSelectElementIsRenderedCorrectly=function(a){if(9<=n){var b=a.style.width;a.style.width=0;a.style.width=
b}};ko.utils.setOptionNodeSelectionState=function(a,b){0<=navigator.userAgent.indexOf("MSIE 6")?a.setAttribute("selected",b):a.selected=b};ko.utils.setTextContent=function(a,b){var c=ko.utils.unwrapObservable(b);if(null===c||void 0===c)c="";"innerText"in a?a.innerText=c:a.textContent=c;9<=n&&(a.style.display=a.style.display)};var t=function(a,b,c){c&&b!==ko.selectExtensions.readValue(a)&&ko.selectExtensions.writeValue(a,b);b!==ko.selectExtensions.readValue(a)&&ko.utils.triggerEvent(a,"change")};ko.bindingHandlers.options=
{update:function(a,b,c){if("select"!==a.tagName.toLowerCase())throw Error("options binding applies only to SELECT elements");for(var d=0==a.length,e=ko.utils.arrayMap(ko.utils.arrayFilter(a.childNodes,function(a){return a.tagName&&"option"===a.tagName.toLowerCase()&&a.selected}),function(a){return ko.selectExtensions.readValue(a)||a.innerText||a.textContent}),l=a.scrollTop,f=ko.utils.unwrapObservable(b());0<a.length;)ko.cleanNode(a.options[0]),a.remove(0);if(f){c=c();"number"!=typeof f.length&&(f=
[f]);if(c.optionsCaption){var h=document.createElement("option");ko.utils.setHtml(h,c.optionsCaption);ko.selectExtensions.writeValue(h,c.optionsCaptionValue||void 0);a.appendChild(h)}for(var b=0,k=f.length;b<k;b++){var h=document.createElement("option"),i="string"==typeof c.optionsValue?f[b][c.optionsValue]:f[b],i=ko.utils.unwrapObservable(i);ko.selectExtensions.writeValue(h,i);var j=c.optionsText,i="function"==typeof j?j(f[b]):"string"==typeof j?f[b][j]:i;if(null===i||void 0===i)i="";ko.utils.setTextContent(h,
i);a.appendChild(h)}f=a.getElementsByTagName("option");b=h=0;for(k=f.length;b<k;b++)0<=ko.utils.arrayIndexOf(e,ko.selectExtensions.readValue(f[b]))&&(ko.utils.setOptionNodeSelectionState(f[b],!0),h++);a.scrollTop=l;d&&"value"in c&&t(a,ko.utils.unwrapObservable(c.value),!0);ko.utils.ensureSelectElementIsRenderedCorrectly(a)}}};ko.bindingHandlers.options.optionValueDomDataKey="__ko.optionValueDomData__";var o=function(a,b){if(a instanceof d.Expressions.ConstantExpression&&ko.isObservable(a.value)){b.some(function(b){b.observable===
a.value&&(b.skipExecute=!0)});b.push({observable:a.value,skipExecute:!1});var c=a.value();return Container.createConstantExpression(c,Container.getTypeName(c),a.name+"$Observable")}return a},u=d.Expressions.ParameterResolverVisitor.prototype.VisitProperty;d.Expressions.ParameterResolverVisitor.prototype.VisitProperty=function(a,b){var c=u.call(this,a,b);this.resolvedObservables=this.resolvedObservables||[];return o(c,this.resolvedObservables)};var p=d.Expressions.QueryExpressionCreator.prototype.VisitConstantExpression;
d.Expressions.QueryExpressionCreator.prototype.VisitConstantExpression=function(a,b){p&&(a=p.call(this,a,b));return o(a,this.resolvedObservables)};d.Expressions.QueryExpressionCreator.prototype.VisitCodeExpression=function(a,b){var c=a.source.toString(),c=Container.createCodeParser(this.scopeContext).createExpression(c);this.scopeContext.log({event:"JSCodeExpression",data:c});var d=Container.createConstantValueResolver(a.parameters,window,this.scopeContext),e=Container.createParameterResolverVisitor(),
c=e.Visit(c,d);this.resolvedObservables=(this.resolvedObservables||[]).concat(e.resolvedObservables);this.scopeContext.log({event:"JSCodeExpressionResolved",data:c});d=Container.createCodeToEntityConverter(this.scopeContext);c=d.Visit(c,{queryParameters:a.parameters,lambdaParameters:this.lambdaTypes,frameType:b.frameType});d=Container.createParametricQueryExpression(c,d.parameters);this.scopeContext.log({event:"EntityExpression",data:c});return d};var q=d.Expressions.QueryExpressionCreator.prototype.Visit;
d.Expressions.QueryExpressionCreator.prototype.Visit=function(a,b){var c;a instanceof d.Expressions.FrameOperator?(this.resolvedObservables=[],c=q.call(this,a,b),c.observables=this.resolvedObservables,c.baseExpression=a):c=q.call(this,a,b);return c};var r=d.EntityContext.prototype.executeQuery;d.EntityContext.prototype.executeQuery=function(a,b,c){var d=this,e=a.expression.observables;e&&0<e.length&&e.forEach(function(e){e&&e.observable.subscribe(function(){if(!e.skipExecute){var f=Container.createQueryExpressionCreator(d).Visit(a.expression.baseExpression);
r.call(d,Container.createQueryable(a,f),b,c)}})});r.call(d,a,b,c)};d.EntityWrapper.extend("$data.KoObservableEntity",{constructor:function(a,b){(!b||!b.isAssignableTo||!b.isAssignableTo(d.Entity))&&Guard.raise(new Exception("Type: '"+b+"' is not assignable to $data.Entity"));var c;a instanceof b?c=a:a instanceof d.Entity?Guard.raise(new Exception("innerData is instance of '$data.Entity' instead of '"+b.fullName+"'")):c=new b(a);this._wrappedType=b;this.innerInstance=c},getEntity:function(){return this.innerInstance},
updateEntity:function(a){var b;a instanceof this._wrappedType?b=a:a&&!(a instanceof d.Entity)&&a instanceof d.Object?b=a:Guard.raise("entity is an invalid object");for(var a=this._wrappedType.memberDefinitions.getPublicMappedProperties(),c=0;c<a.length;c++){var g=a[c];void 0!==b[g.name]&&(this[g.name](b[g.name]),g=this.innerInstance.changedProperties.indexOf(g),0<=g&&this.innerInstance.changedProperties.splice(g,1))}},getProperties:function(){var a=this;return this.innerInstance.getType().memberDefinitions.getPublicMappedProperties().map(function(b){return{type:b.type,
name:b.name,owner:a,metadata:b,value:a[b.name]}})}});d.Entity.prototype.asKoObservable=function(){var a=this.getType(),b=a.namespace+".Observable"+a.name;Container.isTypeRegistered(b)||m(a,b);var c=Container.resolveType(b);c.isWrappedType(a)||(m(a,b),c=Container.resolveType(b));return new c(this)};var s=d.Queryable.prototype.toArray;d.Queryable.prototype.toArray=function(a,b){if(ko.isObservable(a)){if("undefined"!==typeof a.push){var c=d.typeSystem.createCallbackSetting();return this.toArray(function(b){a([]);
b.forEach(function(b){b instanceof d.Entity?a.push(b.asKoObservable()):c.error("Not Implemented: Observable result has anonymous objects")})},b)}return s.call(this,function(b){a(b)},b)}return s.call(this,a,b)}}else d.Entity.prototype.asKoObservable=function(){Guard.raise(new Exception("Knockput js is required","Not Found!"))}})($data);
