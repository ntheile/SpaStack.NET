// JayData 1.3.4
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
(function(b,c,h){var f=c.OData;f.originalHttpClient=f.defaultHttpClient;b.postMessageODataHandler={postMessageHttpClient:{targetIframe:h,request:function(a,e,g){var d=a.targetIframe||b.postMessageODataHandler.postMessageHttpClient.targetIframe,h=a.targetOrigin||b.postMessageODataHandler.postMessageHttpClient.targetOrigin||"*";if(d){var i=function(a){b.Trace.log("in listener");c.removeEventListener("message",i);var d=a.data.statusCode;200<=d&&299>=d?e(a.data):g(a.data)};c.addEventListener("message",
i,!1);b.Trace.log("before post",d);d.postMessage(a,h)}else return f.originalHttpClient.request(a,e,g)}},requestProxy:function(a,e,g){e=a.success||e;g=a.error||g;delete a.success;delete a.error;var d=a.targetIframe||b.postMessageODataHandler.postMessageHttpClient.targetIframe,f=a.targetOrigin||b.postMessageODataHandler.postMessageHttpClient.targetOrigin||"*";if(d){a.requestProxy=!0;var i=function(a){b.Trace.log("in listener");c.removeEventListener("message",i);var d=a.data.statusCode;200<=d&&299>=
d?e(a.data):g(a.data)};c.addEventListener("message",i,!1);b.Trace.log("before post",d);d.postMessage(a,f)}else g({message:"No iframe detected",request:a,response:h})}};f.defaultHttpClient=b.postMessageODataHandler.postMessageHttpClient})($data,window);
(function(b){b.MsCrm={disableBatch:!0};b.MsCrm.Auth={trace:!0,clientAuthorizationPath:"/WebResources/new_authorize.html",messageHandlerPath:"/WebResources/new_postmessage.html",login:function(c,h,f){var a,e=function(d){b.MsCrm.Auth.trace&&console.log("Message received",c);d.data.MessageHandlerLoaded&&(b.MsCrm.Auth.trace&&console.log("Message handler loaded",c),window.removeEventListener("message",e),window.OData.defaultHttpClient.targetIframe=a.contentWindow,h(a.contentWindow,c))},g=function(d){a=
document.createElement("iframe");d.data.Authenticated&&(console.log("Logged in to CRM: "+c),window.removeEventListener("message",g),window.addEventListener("message",e),a.src=f?"postmessage.html":c+b.MsCrm.Auth.messageHandlerPath,a.style.display="none",document.body.appendChild(a))};window.addEventListener("message",g);window.open(f?"authorize.html":c+b.MsCrm.Auth.clientAuthorizationPath,"_blank","resizable=false,location=0,menubar=0,toolbar=0,width=400,height=600")}};b.MsCrm.init=function(c,h,f){function a(){if(!h.isAssignableTo||
!h.isAssignableTo(b.EntityContext))f=h,e.disableBatch=b.MsCrm.disableBatch,b.service(g,e,function(a){var b=a();b.onReady().then(function(){f(b,a)})});else{var a=function(){return new h({name:"oData",oDataServiceHost:g,disableBatch:b.MsCrm.disableBatch})},c=a();c.onReady().then(function(){f(c,a)})}}var e={};"object"===typeof c&&c&&(e=c,c=e.url,delete e.url);var g=c+"/XRMServices/2011/OrganizationData.svc";-1<window.location.href.indexOf(c)?a():b.MsCrm.Auth.login(c,function(){a()})}})($data);
