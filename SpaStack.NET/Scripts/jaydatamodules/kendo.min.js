// JayData 1.3.4
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
(function(f){var l=f.Entity.inheritedTypeProcessor;f.kendo={};f.kendo.BaseModelType=kendo.data.Model.define({init:function(a){kendo.data.Model.fn.init.call(this,a)}});var q={"$data.Blob":"string","$data.String":"string","$data.Boolean":"boolean","$data.Integer":"number","$data.Number":"number","$data.Date":"date","$data.DateTimeOffset":"date","$data.Time":"string","$data.Byte":"number","$data.SByte":"number","$data.Int16":"number","$data.Int32":"number","$data.Int64":"number","$data.Decimal":"string",
"$data.Float":"number"};f.Entity.inheritedTypeProcessor=function(a){function g(b){var d=a.memberDefinitions,e={};d.getPublicMappedProperties().forEach(function(a){var c=f.Container.resolveName(a.type);e[a.name]={type:q[c]||"object",nullable:"$data.Boolean"===c?!0:!0!==a.required,defaultValue:a.defaultValue,editable:!a.computed,validation:{required:"$data.Boolean"===c?!1:a.required||"nullable"in a?!a.nullable:!1}}});var c={fields:e,init:function(c){var d=[];b&&b.owningContextType&&(d=b.owningContextType.memberDefinitions.getPublicMappedProperties().filter(function(a){return f.Container.resolveType(a.type)===
f.EntitySet}).map(function(a){return f.Container.resolveType(a.elementType)}));var e={entityBuilder:function(a,h){h.forEach(function(h){if(!0!==h.key&&(!0===h.required||!1===h.nullable)){var b=f.Container.resolveType(h.type);if(b.isAssignableTo&&b.isAssignableTo(f.Entity)&&-1===d.indexOf(b)){var g;c&&(g=c[h.name]);a[h.name]=new b(g,e)}}})}},h=c instanceof a?c:new a(c,e),g=h.initData,k={},j;for(j in g){var m=a.getMemberDefinition(j),i=g[j];if(i instanceof f.Entity)i=i.asKendoObservable(),k[j]=i;else if(m&&
f.Container.resolveType(m.type)===Array){var l=i=f.Container.resolveType(m.elementType);i.asKendoModel&&(l=i.asKendoModel());i=new kendo.data.ObservableArray(g[j],l);k[j]=i;k[j].bind("change",function(){h.changeFromKendo=!0;this.parent().dirty=!0;h[m.name]=this.toJSON();delete h.changeFromKendo})}else k[j]=m&&f.Container.resolveType(m.type)===f.Blob?f.Blob.toBase64(i):i}i=a.memberDefinitions.getPublicMappedProperties().filter(function(a){return f.Container.resolveType(a.dataType)===Array&&!f.Container.resolveType(a.elementType).asKendoModel});
for(j=0;j<i.length;j++){var n=i[j];if(null===g[n.name]||void 0===g[n.name])k[n.name]=new kendo.data.ObservableArray([],f.Container.resolveType(n.elementType)),k[n.name].bind("change",function(){h.changeFromKendo=!0;this.parent().dirty=!0;h[n.name]=this.toJSON();delete h.changeFromKendo})}var p=this;this.innerInstance=function(){return h};f.kendo.BaseModelType.fn.init.call(this,k);h.propertyChanged.attach(function(a,c){var b=c.newValue,d=h.getType().getMemberDefinition(c.propertyName);this.changeFromKendo?
f.Container.resolveType(d.type)===f.Blob&&(b=f.Blob.toString(b),b=f.Container.convertTo(atob(b),f.Blob),h.changeFromJay=!0,h.initData[d.name]=b,delete h.changeFromJay):(b=b?b.asKendoObservable?b.asKendoObservable():b:b,h.changeFromJay=!0,f.Container.resolveType(d.type)===f.Blob&&b&&(b=f.Blob.toBase64(b)),p.set(c.propertyName,b),d.computed&&p[c.propertyName]!==b&&(p[c.propertyName]=b),delete h.changeFromJay)});this.bind("set",function(a){var c=a.field,d=c.split(".");h.changeFromKendo=!0;1==d.length?
(d=a.value,h.changeFromJay||(d=d.innerInstance?d.innerInstance():d,h[c]=d,b&&b.autoSave&&h.save())):(c=h[d[0]],c instanceof f.Entity&&(h[d[0]]=c));delete h.changeFromKendo});b&&b.newInstanceCallback&&b.newInstanceCallback(h)},save:function(){return this.innerInstance().save()},remove:function(){return this.innerInstance().remove()}},d=d.getKeyProperties();switch(d.length){case 0:break;case 1:c.id=d[0].name;break;default:console.warn("entity with multiple keys not supported")}console.log("md",c);return kendo.data.Model.define(f.kendo.BaseModelType,
c)}function e(a,d){if(d.provider){var e=(d.databaseName||"")+(d.tableName||"")+(d.url||"")+(d.apiUrl||"")+(d.oDataServiceHost||""),c={provider:d.provider,databaseName:d.databaseName,tableName:d.tableName,dataSource:d.url,apiUrl:d.apiUrl,oDataServiceHost:d.oDataServiceHost};Object.keys(c).forEach(function(a){delete d[a]});a.setStore(e,c);return e}}a.asKendoModel=function(b){var d=b||a;return d.kendoModelType||(d.kendoModelType=g(b))};a.prototype.asKendoObservable=function(b){return new (a.asKendoModel(b))(this)};
a.asKendoDataSource=function(b,d,g){b=b||{};d=d||{};g=e(a,b)||g;g=f.ItemStore._getStoreAlias(a,g);return f.ItemStore._getContextPromise(g,a).getEntitySetFromElementType(a).asKendoDataSource(b,d)};l&&l(a)};f.Queryable.addMember("asKendoColumns",function(a){function g(a){a=Array.isArray(a)?a:[a];a=this.concat(a);return d(a)}function e(a){a=Array.isArray(a)?a:[a];a=a.concat(this);return d(a)}function b(a,c){var b=this.filter(function(c){return c.field==a})[0];$.extend(b,c);return this}function d(a){a.prepend=
e;a.append=g;a.setColumn=b;return a}var k=[],a=a||{},c=!0===a.$showComplexFields;delete a.$showComplexFields;this.defaultType.memberDefinitions.getPublicMappedProperties().forEach(function(b){if(c||q[f.Container.resolveName(b.type)]){var d={field:b.name};$.extend(d,a[b.name]||{});k.push(d)}});return d(k)});f.EntityContext.addProperty("EntitySetNames",function(){var a=this;return Object.keys(a._entitySetReferences).map(function(g){return a._entitySetReferences[g].tableName})});f.Queryable.addMember("asKendoModel",
function(a){a.owningContextType=a.owningContextType||this.entityContext.getType();return this.defaultType.asKendoModel(a)});f.Queryable.addMember("asKendoRemoteTransportClass",function(){var a=this,g=a.entityContext;return kendo.data.RemoteTransport.extend({init:function(){this.items=[]},read:function(e){a.entityContext.onReady().then(function(){var b=a,d=a.entityContext.storageProvider.supportedSetOperations.withInlineCount,g=!d&&a.entityContext.storageProvider.supportedSetOperations.length;d&&(b=
b.withInlineCount());if(e.data.filter){var c="",f={};e.data.filter.filters.forEach(function(a,b){0<b&&(c+="or"==e.data.filter.logic?" || ":" && ");switch(a.operator){case "eq":c+="it."+a.field;c+=" == this."+a.field;break;case "neq":c+="it."+a.field;c+=" != this."+a.field;break;case "startswith":c+="it."+a.field;c+=".startsWith(this."+a.field+")";break;case "contains":c+="it."+a.field;c+=".contains(this."+a.field+")";break;case "doesnotcontain":c+="!";c+="it."+a.field;c+=".contains(this."+a.field+
")";break;case "endswith":c+="it."+a.field;c+=".endsWith(this."+a.field+")";break;case "gte":c+="it."+a.field;c+=" >= this."+a.field;break;case "gt":c+="it."+a.field;c+=" > this."+a.field;break;case "lte":c+="it."+a.field;c+=" <= this."+a.field;break;case "lt":c+="it."+a.field;c+=" < this."+a.field;break;default:console.log("unknown operator",a.operator)}f[a.field]=a.value});b=b.filter(c,f)}var l=b;e.data.sort&&e.data.sort.forEach(function(a){b=b.order(("desc"==a.dir?"-":"")+a.field)});e.data.skip&&
(b=b.skip(e.data.skip));e.data.take&&(b=b.take(e.data.take));var o=[];o.push(b.toArray());g?o.push(l.length()):d||o.push(l.toArray());console.log(o);jQuery.when.apply(this,o).then(function(a,c){console.dir(arguments);var b={data:a.map(function(a){return a.asKendoObservable()}),total:d?a.totalCount:g?c:c.length};console.log(b);e.success(b)}).fail(function(){console.log("error in create");e.error({},arguments)})})},create:function(e,b){a.entityContext.onReady().then(function(){if(1<b.length){var a=
[];b.forEach(function(b){a.push(b.innerInstance())});g.addMany(a);g.saveChanges().then(function(){var b=[];a.forEach(function(a){b.push(a.initData)});e.success()}).fail(function(){console.log("error in create");e.error({},arguments);g.stateManager.reset()})}else console.dir(g.storeToken),b[0].innerInstance().save(g.storeToken).then(function(){e.success()}).fail(function(){console.log("error in create");e.error({},arguments)})})},update:function(e,b){a.entityContext.onReady().then(function(){1<b.length?
(b.map(function(a){return a.innerInstance()}).forEach(function(a){g.attach(a,!0)}),g.saveChanges().then(function(){e.success()}).fail(function(){g.stateManager.reset();e.error({},arguments)})):b[0].innerInstance().save().then(function(){e.success()}).fail(function(){e.error({},arguments)})})},destroy:function(e,b){a.entityContext.onReady().then(function(){1<b.length?(b.forEach(function(a){g.remove(a.innerInstance())}),g.saveChanges().then(function(){e.success({data:e.data})}).fail(function(){g.stateManager.reset();
e.error({},"error",e.data)})):b[0].innerInstance().remove().then(function(){e.success({data:e.data})}).fail(function(){g.stateManager.reset();e.error({},"error",e.data)})})},setup:function(){console.log("setup");console.dir(arguments)}})});var r=kendo.data.DataSource.extend({init:function(){kendo.data.DataSource.fn.init.apply(this,arguments)},createItem:function(a){return new this.options.schema.model(a)},_promise:function(a,g,e){var b=this,d=$.extend,f=b.transport;return $.Deferred(function(c){f[e].call(f,
d({success:function(a){c.resolve({response:a,models:g,type:e})},error:function(a,d,e){c.reject(a);b.error(a,d,e)}},a),g)}).promise()}});f.kendo=f.kendo||{};f.kendo.defaultPageSize=25;f.Queryable.addMember("asKendoDataSource",function(a,g){var g=g||{},e=this.asKendoModel(g),a=a||{};a.serverPaging=a.serverPaging||!0;a.serverFiltering=a.serverFiltering||!0;a.serverSorting=a.serverSorting||!0;a.pageSize=void 0===a.pageSize?f.kendo.defaultPageSize:a.pageSize;var b=this.asKendoRemoteTransportClass(e);a.transport=
new b;a.schema={model:e,data:"data",total:"total"};return new r(a)});kendo.data.binders.submit=kendo.data.Binder.extend({init:function(a,f,e){kendo.data.Binder.fn.init.call(this,a,f,e);$(a).bind("submit",function(){var a=f.submit.source,d=a[f.submit.path];if("function"===typeof d)return d.apply(a,arguments),!1})},refresh:function(){}})})($data);
