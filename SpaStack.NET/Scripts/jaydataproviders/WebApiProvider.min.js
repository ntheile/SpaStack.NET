// JayData 1.3.4
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
$data.WebApiConverter={fromDb:{"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Date":function(a){if(a){if(a instanceof Date)return a;
if("/Date("===a.substring(0,6))return new Date(parseInt(a.substr(6)));-1===a.indexOf("Z")&&!a.match("T.*[+-]")&&(a+="Z");return new Date(a)}return a},"$data.DateTimeOffset":function(a){if(a){if(a instanceof Date)return a;if("/Date("===a.substring(0,6))return new Date(parseInt(a.substr(6)));-1===a.indexOf("Z")&&!a.match("T.*[+-]")&&(a+="Z");return new Date(a)}return a},"$data.Time":$data.Container.proxyConverter,"$data.String":$data.Container.proxyConverter,"$data.Boolean":$data.Container.proxyConverter,
"$data.Blob":function(a){if("string"==typeof a)try{return $data.Container.convertTo(atob(a),"$data.Blob")}catch(b){return a}else return a},"$data.Object":function(a){return void 0===a?new $data.Object:"string"===typeof a?JSON.parse(a):a},"$data.Array":function(a){return void 0===a?new $data.Array:a instanceof $data.Array?a:JSON.parse(a)},"$data.GeographyPoint":function(a){return a&&"object"===typeof a&&Array.isArray(a.coordinates)?new $data.GeographyPoint(a.coordinates):a},"$data.Guid":function(a){return a?
a.toString():a}},toDb:{"$data.Entity":$data.Container.proxyConverter,"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.ObjectID":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,
"$data.Date":function(a){return a?a.toISOString().replace("Z",""):a},"$data.Time":$data.Container.proxyConverter,"$data.DateTimeOffset":function(a){return a?a.toISOString():a},"$data.String":$data.Container.proxyConverter,"$data.Boolean":$data.Container.proxyConverter,"$data.Blob":function(a){return a?$data.Blob.toBase64(a):a},"$data.Object":$data.Container.proxyConverter,"$data.Array":$data.Container.proxyConverter,"$data.GeographyPoint":$data.Container.proxyConverter,"$data.Guid":$data.Container.proxyConverter},
escape:{"$data.Entity":function(a){return JSON.stringify(a)},"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":function(a){return a?a+"m":a},"$data.Float":function(a){return a?a+"f":a},"$data.Int64":function(a){return a?a+"L":a},"$data.Time":function(a){return a?
"time'"+a+"'":a},"$data.DateTimeOffset":function(a){return a?"datetimeoffset'"+a+"'":a},"$data.Date":function(a){return a?"datetime'"+a+"'":a},"$data.String":function(a){return"string"===typeof a?"'"+a.replace(/'/g,"''")+"'":a},"$data.ObjectID":function(a){return"string"===typeof a?"'"+a.replace(/'/g,"''")+"'":a},"$data.Boolean":function(a){return"boolean"===typeof a?a.toString():a},"$data.Blob":function(a){return a?"X'"+$data.Blob.toHexString($data.Container.convertTo(atob(a),$data.Blob))+"'":a},
"$data.Object":function(a){return JSON.stringify(a)},"$data.Array":function(a){return JSON.stringify(a)},"$data.GeographyPoint":function(a){return a?$data.GeographyBase.stringifyToUrl(a):a},"$data.Guid":function(a){return a?"guid'"+a.toString()+"'":a}}};
$C("$data.Expressions.ExpressionWalker",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.Visit=function(b,c){var e=b,d;this.canVisit(b)&&(a.VisitExpressionNode&&a.VisitExpressionNode.apply(a,arguments),d="Visit"+b.getType().name,d in a&&(e=a[d].apply(a,arguments)));var g=arguments;e!==b&&(g=[e,c]);e=$data.Expressions.EntityExpressionVisitor.prototype.Visit.apply(this,g);g=[e,c];if(this.canVisit(e)){var f=e.getType().name;a.MonitorExpressionNode&&a.MonitorExpressionNode.apply(a,
g);d="Monitor"+f;d in a&&a[d].apply(a,g);a.MutateExpressionNode&&a.MutateExpressionNode.apply(a,g);d="Mutate"+f;d in a&&(e=a[d].apply(a,g))}return e}}});$data.Expressions.ExpressionNode.prototype.walk=function(a,b){return Container.createExpressionWalker(a).Visit(this,b)};$data.Expressions.ExpressionNode.prototype.dig=function(a){var b=[];this.walk({MonitorExpressionNode:function(c){var e;(e=a(c))&&b.push(e)}});return b};
$C("$data.storageProviders.webApi.webApiProvider",$data.StorageProviderBase,null,{constructor:function(a,b){this.context=b;this.providerConfiguration=$data.typeSystem.extend({dbCreation:$data.storageProviders.DbCreationType.DropTableIfChanged,apiUrl:"/odata.svc",serviceUrl:"",maxDataServiceVersion:"2.0",user:null,password:null,withCredentials:!1,enableJSONP:!1},a);this.context&&this.context._buildDbType_generateConvertToFunction&&this.buildDbType_generateConvertToFunction&&(this.context._buildDbType_generateConvertToFunction=
this.buildDbType_generateConvertToFunction);this.context&&this.context._buildDbType_modifyInstanceDefinition&&this.buildDbType_modifyInstanceDefinition&&(this.context._buildDbType_modifyInstanceDefinition=this.buildDbType_modifyInstanceDefinition)},initializeStore:function(a){a=$data.typeSystem.createCallbackSetting(a);a.success(this.context)},buildDbType_generateConvertToFunction:function(a,b){return function(c,e){var d=new a.PhysicalType;d.entityState=c.entityState;a.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(a){d.initData[a.name]=
c[a.name]},this);a.Associations&&a.Associations.forEach(function(a){if("*"==a.FromMultiplicity&&"0..1"==a.ToMultiplicity||"0..1"==a.FromMultiplicity&&"1"==a.ToMultiplicity||"$$unbound"==a.FromMultiplicity){var f=c[a.FromPropertyName];if(null!==f&&void 0!==f)if(f instanceof $data.Array)d.initData[a.FromPropertyName]=d[a.FromPropertyName]||[],f.forEach(function(b){b=e.indexOf(b);0>b&&Guard.raise("Dependency graph error");d.initData[a.FromPropertyName].push({__metadata:{uri:"$"+(b+1)}})},this);else if(f.entityState===
$data.EntityState.Modified){var h=b._storageModel.getStorageModel(f.getType()).TableName,f="("+b.storageProvider.getEntityKeysValue({data:f,entitySet:b.getEntitySetFromElementType(f.getType())})+")";d.initData[a.FromPropertyName]={__metadata:{uri:h+f}}}else h=e.indexOf(f),0>h&&Guard.raise("Dependency graph error"),d.initData[a.FromPropertyName]={__metadata:{uri:"$"+(h+1)}}}},this);a.ComplexTypes&&a.ComplexTypes.forEach(function(a){d.initData[a.FromPropertyName]=c[a.FromPropertyName]},this);return d}},
buildDbType_modifyInstanceDefinition:function(){},executeQuery:function(a,b){var b=$data.typeSystem.createCallbackSetting(b),c;try{c=this._compile(a)}catch(e){b.error(e);return}(function(a){var b=$data.Expressions,d=0,e=a.expression.dig(function(c){c instanceof b.SimpleBinaryExpression&&d++;if("equal"==c.nodeType){var e=null,i=null;c.left instanceof b.ConstantExpression&&(e=c.left);c.left instanceof b.EntityFieldExpression&&(i=c.left);c.right instanceof b.ConstantExpression&&(e=c.right);c.right instanceof
b.EntityFieldExpression&&(i=c.right);if(i&&e&&i.source.entityType===a.defaultType&&i.selector.memberName==a.defaultType.memberDefinitions.getKeyProperties()[0].name)return e.value}});1==d&&1==e.length&&(c.queryText="/"+a.context.getEntitySetFromElementType(a.defaultType).tableName+"/"+e[0].toString())})(a);var d={url:this.providerConfiguration.apiUrl+c.queryText,type:c.method,success:function(c){b.success&&(a.rawDataList="string"===typeof c?[{cnt:c}]:c,b.success(a))},error:function(){console.dir(arguments);
b.error(arguments)}};this.appendBasicAuth(d,this.providerConfiguration.user,this.providerConfiguration.password,this.providerConfiguration.withCredentials);this.context.prepareRequest.call(this,d);$data.ajax(d)},_compile:function(a){return(new $data.storageProviders.webApi.webApiCompiler).compile(a)},saveChanges:function(a,b){0<b.length?this.saveInternal(this.buildIndependentBlocks(b),0,a):a.success(0)},saveInternal:function(a,b,c){(!0===this.providerConfiguration.disableBatch||"object"===typeof $data.defaults&&
!0===$data.defaults.disableBatch)&&"function"===typeof this._saveRestMany?this._saveRestMany(a,b,c):1<a.length||1==a.length&&1<a[0].length?this._saveBatch(a,b,c):this._saveRest(a,b,c)},_saveRest:function(a,b,c){for(var e=[],d,b=0;b<a.length;b++)for(var g=0;g<a[b].length;g++){e.push(a[b][g].data);d={url:this.providerConfiguration.apiUrl+"/",headers:{},contentType:"application/json",dataType:"json"};switch(a[b][g].data.entityState){case $data.EntityState.Unchanged:continue;case $data.EntityState.Added:d.type=
"POST";d.url+=a[b][g].entitySet.tableName;d.data=this.save_getInitData(a[b][g],e);break;case $data.EntityState.Modified:d.type="PUT";d.url+=a[b][g].entitySet.tableName;d.url+="/"+this.getEntityKeysValue(a[b][g]);this.save_addConcurrencyHeader(a[b][g],d.headers);d.data=this.save_getInitData(a[b][g],e);break;case $data.EntityState.Deleted:d.type="DELETE";d.url+=a[b][g].entitySet.tableName;d.url+="/"+this.getEntityKeysValue(a[b][g]);this.save_addConcurrencyHeader(a[b][g],d.headers);break;default:Guard.raise(new Exception("Not supported Entity state"))}d.data&&
(d.data=JSON.stringify(d.data))}var f=this;d.success=function(a,b,d){b=d.status;if(200<=b&&300>b){if(a){var g=e[0];g.getType().memberDefinitions.getPublicMappedProperties().forEach(function(b){var c=Container.resolveType(b.type);if(b.computed||b.key||!c.isAssignableTo&&!b.inverseProperty)c=f.fieldConverter.fromDb[Container.resolveName(b.type)],g[b.name]=c?c(a[b.name]):a[b.name]},this)}c.success&&c.success(e.length)}else c.error(response)};d.error=function(a){c.error(new Exception((a.response||{}).body,
a.message,a))};this.appendBasicAuth(d,this.providerConfiguration.user,this.providerConfiguration.password,this.providerConfiguration.withCredentials);this.context.prepareRequest.call(this,d);$data.ajax(d)},_saveBatch:function(a,b,c){for(var b=[],e=[],d=0;d<a.length;d++)for(var g=0;g<a[d].length;g++){e.push(a[d][g].data);var f={};f.headers={"Content-Id":e.length};switch(a[d][g].data.entityState){case $data.EntityState.Unchanged:continue;case $data.EntityState.Added:f.method="POST";f.requestUri=a[d][g].entitySet.tableName;
f.data=this.save_getInitData(a[d][g],e);break;case $data.EntityState.Modified:f.method="MERGE";f.requestUri=a[d][g].entitySet.tableName;f.requestUri+="("+this.getEntityKeysValue(a[d][g])+")";this.save_addConcurrencyHeader(a[d][g],f.headers);f.data=this.save_getInitData(a[d][g],e);break;case $data.EntityState.Deleted:f.method="DELETE";f.requestUri=a[d][g].entitySet.tableName;f.requestUri+="("+this.getEntityKeysValue(a[d][g])+")";this.save_addConcurrencyHeader(a[d][g],f.headers);break;default:Guard.raise(new Exception("Not supported Entity state"))}b.push(f)}var h=
this,a=[{requestUri:this.providerConfiguration.apiUrl+"/$batch",method:"POST",data:{__batchRequests:[{__changeRequests:b}]}},function(a,b){if(202==b.statusCode){for(var d=a.__batchResponses[0].__changeResponses,g=[],f=0;f<d.length;f++)if(200<d[f].statusCode&&300>d[f].statusCode){var j=e[f];if(204==d[f].statusCode){if(d[f].headers.ETag||d[f].headers.Etag||d[f].headers.etag){var l=j.getType().memberDefinitions.getPublicMappedProperties().filter(function(a){return a.concurrencyMode===$data.ConcurrencyMode.Fixed});
l&&l[0]&&(j[l[0].name]=d[f].headers.ETag||d[f].headers.Etag||d[f].headers.etag)}}else j.getType().memberDefinitions.getPublicMappedProperties().forEach(function(a){if(a.computed||a.key)if(a.concurrencyMode===$data.ConcurrencyMode.Fixed)j[a.name]=d[f].headers.ETag||d[f].headers.Etag||d[f].headers.etag;else{var b=h.fieldConverter.fromDb[Container.resolveType(a.type)];j[a.name]=b?b(d[f].data[a.name]):d[f].data[a.name]}},this)}else g.push(new Exception((d[f].response||{}).body,d[f].message,d[f]));0<g.length?
c.error(new Exception("See inner exceptions","Batch failed",g)):c.success&&c.success(e.length)}else c.error(b)},function(a){c.error(new Exception((a.response||{}).body,a.message,a))},OData.batchHandler];this.appendBasicAuth(a[0],this.providerConfiguration.user,this.providerConfiguration.password,this.providerConfiguration.withCredentials);this.context.prepareRequest.call(this,a);OData.request.apply(this,a)},save_getInitData:function(a,b){a.physicalData=this.context._storageModel.getStorageModel(a.data.getType()).PhysicalType.convertTo(a.data,
b);var c={};a.physicalData.getType().memberDefinitions.asArray().forEach(function(b){if(b.kind==$data.MemberTypes.navProperty||b.kind==$data.MemberTypes.complexProperty||b.kind==$data.MemberTypes.property&&!b.notMapped)c[b.name]=a.physicalData[b.name]},this);return c},save_addConcurrencyHeader:function(a,b){var c=a.data.getType().memberDefinitions.getPublicMappedProperties().filter(function(a){return a.concurrencyMode===$data.ConcurrencyMode.Fixed});c&&c[0]&&(b["If-Match"]=a.data[c[0].name])},getTraceString:function(a){this._compile(a);
return a},supportedDataTypes:{value:[$data.Integer,$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date,$data.Object,$data.GeographyPoint,$data.Guid,$data.Byte,$data.SByte,$data.Decimal,$data.Float,$data.Int16,$data.Int32,$data.Int64,$data.Time,$data.DateTimeOffset],writable:!1},supportedBinaryOperators:{value:{equal:{mapTo:"eq",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqual:{mapTo:"ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,
$data.Expressions.OrderExpression]},equalTyped:{mapTo:"eq",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqualTyped:{mapTo:"ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThan:{mapTo:"gt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThanOrEqual:{mapTo:"ge",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,
$data.Expressions.OrderExpression]},lessThan:{mapTo:"lt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThenOrEqual:{mapTo:"le",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},or:{mapTo:"or",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},and:{mapTo:"and",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},
add:{mapTo:"add",dataType:"number",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},divide:{mapTo:"div",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},multiply:{mapTo:"mul",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},subtract:{mapTo:"sub",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},modulo:{mapTo:"mod",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},
"in":{mapTo:"in",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]}}},supportedUnaryOperators:{value:{not:{mapTo:"not"}}},supportedFieldOperations:{value:{contains:{mapTo:"substringof",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"substring",dataType:"string"},{name:"@expression"}]},startsWith:{mapTo:"startswith",dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],
parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},endsWith:{mapTo:"endswith",dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},length:{dataType:"number",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],parameters:[{name:"@expression",dataType:"string"}]},strLength:{mapTo:"length",
dataType:"number",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],parameters:[{name:"@expression",dataType:"string"}]},indexOf:{dataType:"number",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],mapTo:"indexof",baseIndex:1,parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},replace:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",
dataType:"string"},{name:"strFrom",dataType:"string"},{name:"strTo",dataType:"string"}]},substr:{mapTo:"substring",dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"},{name:"startFrom",dataType:"number"},{name:"length",dataType:"number",optional:"true"}]},toLowerCase:{mapTo:"tolower",dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",
dataType:"string"}]},toUpperCase:{mapTo:"toupper",dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"}]},trim:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"}]},concat:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"string"},
{name:"strFragment",dataType:"string"}]},day:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},hour:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},minute:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},month:{allowedIn:[$data.Expressions.FilterExpression,
$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},second:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},year:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},round:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},
floor:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]},ceiling:{allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression],parameters:[{name:"@expression",dataType:"date"}]}},enumerable:!0,writable:!0},supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},some:{invokable:!1,allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"filter",dataType:"$data.Queryable"}],
mapTo:"any",frameType:$data.Expressions.SomeExpression},every:{invokable:!1,allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"filter",dataType:"$data.Queryable"}],mapTo:"all",frameType:$data.Expressions.EveryExpression},take:{},skip:{},orderBy:{},orderByDescending:{},first:{},include:{},batchDelete:{}},enumerable:!0,writable:!0},fieldConverter:{value:$data.WebApiConverter},getEntityKeysValue:function(a){for(var b=[],c=void 0,e=a.entitySet.createNew.memberDefinitions.asArray(),d=0,
g=e.length;d<g;d++){var f=e[d];if(f.key){c=a.data[f.name];switch(Container.getName(f.originalType)){case "$data.Guid":case "Edm.Guid":c="guid'"+(c?c.value:c)+"'";break;case "$data.Blob":case "Edm.Binary":c="binary'"+c+"'";break;case "Edm.Byte":c="0123456789ABCDEF"[d>>4&15]+"0123456789ABCDEF"[d&15];break;case "$data.Date":case "Edm.DateTime":c="datetime'"+c.toISOString()+"'";break;case "Edm.Decimal":c+="M";break;case "Edm.Single":c+="f";break;case "Edm.Int64":c+="L";break;case "Edm.String":case "$data.String":c=
"'"+c+"'"}b.push(f.name+"="+c)}}return 1<b.length?b.join(","):c},appendBasicAuth:function(a,b,c,e){a.headers=a.headers||{};!a.headers.Authorization&&b&&c&&(a.headers.Authorization="Basic "+this.__encodeBase64(b+":"+c),a.withCredentials=e)},__encodeBase64:function(a){var b="",c,e,d="",g,f,h="",k=0;do c=a.charCodeAt(k++),e=a.charCodeAt(k++),d=a.charCodeAt(k++),g=c>>2,c=(c&3)<<4|e>>4,f=(e&15)<<2|d>>6,h=d&63,isNaN(e)?f=h=64:isNaN(d)&&(h=64),b=b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)+
"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(c)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(h);while(k<a.length);return b}},null);$data.StorageProviderBase.registerProvider("webApi",$data.storageProviders.webApi.webApiProvider);
$C("$data.storageProviders.webApi.webApiCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){this.context={};this.provider={};this.mainEntitySet=this.includes=null},compile:function(a){this.provider=a.context.storageProvider;this.context=a.context;this.mainEntitySet=a.context.getEntitySetFromElementType(a.defaultType);var b={urlText:""};this.Visit(a.expression,b);a.modelBinderConfig={};Container.createModelBinderConfigCompiler(a,this.includes,!0).Visit(a.expression);var c=
b.urlText,e=!1,d;for(d in b)"urlText"!=d&&"actionPack"!=d&&"data"!=d&&"lambda"!=d&&"method"!=d&&""!=b[d]&&(c=e?c+"&":c+"?",e=!0,c="$urlParams"!=d?c+(d+"="+b[d]):c+b[d]);a.queryText=c;return{queryText:c,method:b.method||"GET",params:[]}},VisitOrderExpression:function(a,b){this.Visit(a.source,b);Container.createwebApiOrderCompiler(this.provider).compile(a,b)},VisitPagingExpression:function(a,b){this.Visit(a.source,b);Container.createwebApiPagingCompiler().compile(a,b)},VisitIncludeExpression:function(a,
b){this.Visit(a.source,b);if(!b.$select){b.$expand=b.$expand?b.$expand+",":"";b.$expand+=a.selector.value.replace(/\./g,"/");this.includes=this.includes||[];for(var c=a.selector.value.split("."),e=null,d=this.mainEntitySet.entityContext._storageModel.getStorageModel(this.mainEntitySet.createNew),g=0;g<c.length;g++)e=e?e+("."+c[g]):c[g],(d=d.Associations[c[g]])?this.includes.some(function(a){return a.name==e},this)||this.includes.push({name:e,type:d.ToType}):Guard.raise(new Exception("The given include path is invalid: "+
a.selector.value+", invalid point: "+e)),d=this.mainEntitySet.entityContext._storageModel.getStorageModel(d.ToType)}},VisitProjectionExpression:function(a,b){this.Visit(a.source,b);Container.createwebApiProjectionCompiler(this.context).compile(a,b)},VisitFilterExpression:function(a,b){this.Visit(a.source,b);var c=Container.createwebApiWhereCompiler(this.provider);b.data="";c.compile(a.selector,b);b.$filter=b.data;b.data=""},VisitEntitySetExpression:function(a,b){b.urlText+="/"+a.instance.tableName;
if(a.params)for(var c=0;c<a.params.length;c++)this.Visit(a.params[c],b)},VisitServiceOperationExpression:function(a,b){b.urlText+="/"+a.cfg.serviceName;if(a.params)for(var c=0;c<a.params.length;c++)this.Visit(a.params[c],b)},VisitBatchDeleteExpression:function(a,b){this.Visit(a.source,b);b.urlText+="/$batchDelete";b.method="DELETE"},VisitConstantExpression:function(a,b){b.$urlParams=b.$urlParams?b.$urlParams+"&":"";var c=Container.resolveName(a.type);a.value instanceof $data.Entity&&(c=$data.Entity.fullName);
var e=this.provider.fieldConverter.toDb[c],d=e?e(a.value):a.value,d=(e=this.provider.fieldConverter.escape[c])?e(d):d;b.$urlParams+=a.name+"="+d},VisitCountExpression:function(a,b){this.Visit(a.source,b);b.urlText+="/$count"}},{});
$C("$data.storageProviders.webApi.webApiWhereCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a,b){this.provider=a;this.lambdaPrefix=b},compile:function(a,b){this.Visit(a,b)},VisitParametricQueryExpression:function(a,b){this.Visit(a.expression,b)},VisitUnaryExpression:function(a,b){b.data+=a.resolution.mapTo;b.data+="(";this.Visit(a.operand,b);b.data+=")"},VisitSimpleBinaryExpression:function(a,b){b.data+="(";if("in"==a.nodeType){Guard.requireType("expression.right",
a.type,$data.Expressions.ConstantExpression);var c=a.right.value;!c instanceof Array&&Guard.raise(new Exception("Right to the 'in' operator must be an array value"));var e=null,d={mapTo:"or",dataType:"boolean",name:"or"},g={mapTo:"eq",dataType:"boolean",name:"equal"};c.forEach(function(b){b=Container.createSimpleBinaryExpression(a.left,b,$data.Expressions.ExpressionType.Equal,"==","boolean",g);e=e?Container.createSimpleBinaryExpression(e,b,$data.Expressions.ExpressionType.Or,"||","boolean",d):b});
c=b.data;b.data="";this.Visit(e,b);b.data=c+b.data.replace(/\(/g,"").replace(/\)/g,"")}else this.Visit(a.left,b),b.data+=" ",b.data+=a.resolution.mapTo,b.data+=" ",this.Visit(a.right,b);b.data+=")"},VisitEntityFieldExpression:function(a,b){this.Visit(a.source,b);a.source instanceof $data.Expressions.ComplexTypeExpression&&(b.data+="/");this.Visit(a.selector,b)},VisitAssociationInfoExpression:function(a,b){b.data+=a.associationInfo.FromPropertyName},VisitMemberInfoExpression:function(a,b){b.data+=
a.memberName},VisitQueryParameterExpression:function(a,b){var c=Container.resolveName(a.type),e=this.provider.fieldConverter.toDb[c],d=e?e(a.value):a.value,e=this.provider.fieldConverter.escape[c];b.data+=e?e(d):d},VisitEntityFieldOperationExpression:function(a,b){Guard.requireType("expression.operation",a.operation,$data.Expressions.MemberInfoExpression);var c=a.operation.memberDefinition;b.data+=c.mapTo||c.name;b.data+="(";var e=0;(c.parameters||[{name:"@expression"}]).map(function(b){return"@expression"===
b.name?a.source:a.parameters[e++]}).forEach(function(a,c){0<c&&(b.data+=",");this.Visit(a,b)},this);b.data+=")"},VisitConstantExpression:function(a,b){var c=Container.resolveName(a.type),e=this.provider.fieldConverter.toDb[c],d=e?e(a.value):a.value,e=this.provider.fieldConverter.escape[c];b.data+=e?e(d):d},VisitEntityExpression:function(a,b){this.Visit(a.source,b);this.lambdaPrefix&&a.selector.lambda&&(b.lambda=a.selector.lambda,b.data+=a.selector.lambda+"/")},VisitEntitySetExpression:function(a,
b){this.Visit(a.source,b);a.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(a.selector,b),b.data+="/")},VisitFrameOperationExpression:function(a,b){this.Visit(a.source,b);Guard.requireType("expression.operation",a.operation,$data.Expressions.MemberInfoExpression);var c=a.operation.memberDefinition;b.data+=c.mapTo||c.name;b.data+="(";for(var e=0,d=(c.parameters||[{name:"@expression"}]).map(function(b){return"@expression"===b.name?a.source:a.parameters[e++]}),g=0;g<d.length;g++){var f=
d[g];if(f&&f.value instanceof $data.Queryable){var h=new c.frameType(f.value.expression),f=Container.createQueryExpressionCreator(f.value.entityContext).Visit(h),h={data:""};(new $data.storageProviders.webApi.webApiWhereCompiler(this.provider,!0)).compile(f,h);b.data+=h.lambda+": "+h.data}}b.data+=")"}});
$C("$data.storageProviders.webApi.webApiOrderCompiler",$data.storageProviders.webApi.webApiWhereCompiler,null,{constructor:function(a){this.provider=a},compile:function(a,b){this.Visit(a,b)},VisitOrderExpression:function(a,b){var c={data:""};this.Visit(a.selector,c);b.$orderby=b.$orderby?b.$orderby+",":"";b.$orderby+=c.data+(a.nodeType==$data.Expressions.ExpressionType.OrderByDescending?" desc":"")},VisitParametricQueryExpression:function(a,b){this.Visit(a.expression,b)},VisitEntityFieldExpression:function(a,
b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitComplexTypeExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b);b.data+="/"},VisitEntitySetExpression:function(a,b){a.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(a.source,b),this.Visit(a.selector,b))},VisitAssociationInfoExpression:function(a,b){b.data+=a.associationInfo.FromPropertyName+"/"},VisitEntityExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitMemberInfoExpression:function(a,
b){b.data+=a.memberName}});
$C("$data.storageProviders.webApi.webApiPagingCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.provider=a},compile:function(a,b){this.Visit(a,b)},VisitPagingExpression:function(a,b){var c={data:""};this.Visit(a.amount,c);switch(a.nodeType){case $data.Expressions.ExpressionType.Skip:b.$skip=c.data;break;case $data.Expressions.ExpressionType.Take:b.$top=c.data;break;default:Guard.raise("Not supported nodeType")}},VisitConstantExpression:function(a,b){b.data+=a.value}});
$C("$data.storageProviders.webApi.webApiProjectionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.entityContext=a;this.hasObjectLiteral=!1;this.ObjectLiteralPath="";this.modelBinderMapping=[]},compile:function(a,b){this.Visit(a,b)},VisitProjectionExpression:function(a,b){this.mapping=b.data="";this.Visit(a.selector,b);b.$select=b.$select?b.$select+",":"";b.$select+=b.data;b.data=""},VisitParametricQueryExpression:function(a,b){this.Visit(a.expression,b);if(a.expression instanceof
$data.Expressions.EntityExpression||a.expression instanceof $data.Expressions.EntitySetExpression)b.$expand=b.$expand?b.$expand+",":"",b.$expand+=this.mapping.replace(/\./g,"/");var c=this.mapping.split(".");c.pop();0<c.length&&(b.$expand=b.$expand?b.$expand+",":"",b.$expand+=c.join("/"))},VisitObjectLiteralExpression:function(a,b){var c=this.ObjectLiteralPath;this.hasObjectLiteral=!0;a.members.forEach(function(c,d){this.Visit(c,b);d<a.members.length-1&&(b.data+=",");this.mapping=""},this);this.ObjectLiteralPath=
c},VisitObjectFieldExpression:function(a,b){this.ObjectLiteralPath=this.ObjectLiteralPath?this.ObjectLiteralPath+("."+a.fieldName):a.fieldName;this.Visit(a.expression,b);if(a.expression instanceof $data.Expressions.EntityExpression||a.expression instanceof $data.Expressions.EntitySetExpression)b.$expand=b.$expand?b.$expand+",":"",b.$expand+=this.mapping.replace(/\./g,"/");else{var c=this.mapping.split(".");c.pop();0<c.length&&(b.$expand=b.$expand?b.$expand+",":"",b.$expand+=c.join("/"))}},VisitComplexTypeExpression:function(a,
b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitEntityFieldExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitEntityExpression:function(a,b){this.Visit(a.source,b)},VisitEntitySetExpression:function(a,b){a.source instanceof $data.Expressions.EntityExpression&&this.Visit(a.source,b);a.selector instanceof $data.Expressions.AssociationInfoExpression&&this.Visit(a.selector,b)},VisitAssociationInfoExpression:function(a,b){b.data&&0<b.data.length&&","!=b.data[b.data.length-
1]&&(b.data+="/");b.data+=a.associationInfo.FromPropertyName;this.mapping&&0<this.mapping.length&&(this.mapping+=".");this.mapping+=a.associationInfo.FromPropertyName},VisitMemberInfoExpression:function(a,b){b.data&&0<b.data.length&&","!=b.data[b.data.length-1]&&(b.data+="/");b.data+=a.memberName;this.mapping&&0<this.mapping.length&&(this.mapping+=".");this.mapping+=a.memberName},VisitConstantExpression:function(a,b){b.data=b.data.slice(0,b.data.length-1)}});
