// JayData 1.3.4
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
$data.InMemoryConverter={fromDb:{"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Date":$data.Container.proxyConverter,"$data.DateTimeOffset":$data.Container.proxyConverter,
"$data.Time":$data.Container.proxyConverter,"$data.String":$data.Container.proxyConverter,"$data.Boolean":$data.Container.proxyConverter,"$data.Blob":$data.Container.proxyConverter,"$data.Object":function(b){return void 0===b?new $data.Object:b},"$data.Array":function(b){return void 0===b?new $data.Array:b},"$data.Guid":function(b){return b?$data.parseGuid(b).toString():b},"$data.GeographyPoint":function(b){return b?new $data.GeographyPoint(b):b},"$data.GeographyLineString":function(b){return b?new $data.GeographyLineString(b):
b},"$data.GeographyPolygon":function(b){return b?new $data.GeographyPolygon(b):b},"$data.GeographyMultiPoint":function(b){return b?new $data.GeographyMultiPoint(b):b},"$data.GeographyMultiLineString":function(b){return b?new $data.GeographyMultiLineString(b):b},"$data.GeographyMultiPolygon":function(b){return b?new $data.GeographyMultiPolygon(b):b},"$data.GeographyCollection":function(b){return b?new $data.GeographyCollection(b):b},"$data.GeometryPoint":function(b){return b?new $data.GeometryPoint(b):
b},"$data.GeometryLineString":function(b){return b?new $data.GeometryLineString(b):b},"$data.GeometryPolygon":function(b){return b?new $data.GeometryPolygon(b):b},"$data.GeometryMultiPoint":function(b){return b?new $data.GeometryMultiPoint(b):b},"$data.GeometryMultiLineString":function(b){return b?new $data.GeometryMultiLineString(b):b},"$data.GeometryMultiPolygon":function(b){return b?new $data.GeometryMultiPolygon(b):b},"$data.GeometryCollection":function(b){return b?new $data.GeometryCollection(b):
b}},toDb:{"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Date":$data.Container.proxyConverter,"$data.DateTimeOffset":$data.Container.proxyConverter,
"$data.Time":$data.Container.proxyConverter,"$data.String":$data.Container.proxyConverter,"$data.Boolean":$data.Container.proxyConverter,"$data.Blob":$data.Container.proxyConverter,"$data.Object":$data.Container.proxyConverter,"$data.Array":$data.Container.proxyConverter,"$data.Guid":function(b){return b?b.toString():b},"$data.GeographyPoint":function(b){return b},"$data.GeographyLineString":function(b){return b},"$data.GeographyPolygon":function(b){return b},"$data.GeographyMultiPoint":function(b){return b},
"$data.GeographyMultiLineString":function(b){return b},"$data.GeographyMultiPolygon":function(b){return b},"$data.GeographyCollection":function(b){return b},"$data.GeometryPoint":function(b){return b},"$data.GeometryLineString":function(b){return b},"$data.GeometryPolygon":function(b){return b},"$data.GeometryMultiPoint":function(b){return b},"$data.GeometryMultiLineString":function(b){return b},"$data.GeometryMultiPolygon":function(b){return b},"$data.GeometryCollection":function(b){return b}},escape:{"$data.Byte":$data.Container.proxyConverter,
"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Date":function(b){return b?"new Date(Date.parse('"+b.toISOString()+"'))":b},"$data.DateTimeOffset":function(b){return b?"new Date(Date.parse('"+
b.toISOString()+"'))":b},"$data.Time":function(b){return b?"'"+b+"'":b},"$data.String":function(b){return"'"+b.replace(/'/g,"''")+"'"},"$data.Boolean":function(b){return b?"true":"false"},"$data.Blob":function(b){return"'"+$data.Blob.toString(b)+"'"},"$data.Object":function(b){return JSON.stringify(b)},"$data.Array":function(b){return JSON.stringify(b)},"$data.Guid":function(b){return b?"'"+b.toString()+"'":b}}};
$data.mongoDBConverter={fromDb:{"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Date":function(b){return b?new Date(b):b},"$data.DateTimeOffset":function(b){return b?
new Date(b):b},"$data.Time":function(b){return b?Container.convertTo(b,$data.Time):b},"$data.String":$data.Container.proxyConverter,"$data.Boolean":$data.Container.proxyConverter,"$data.Blob":function(b){return b?$data.Container.convertTo("string"===typeof b?atob(b):b.buffer||b,$data.Blob):b},"$data.Object":function(b){return void 0===b?new $data.Object:b},"$data.Array":function(b){return void 0===b?new $data.Array:b},"$data.ObjectID":function(b){return b?(new Buffer(b.toString(),"ascii")).toString("base64"):
b},"$data.GeographyPoint":function(b){return b?new $data.GeographyPoint(b):b},"$data.GeographyLineString":function(b){return b?new $data.GeographyLineString(b):b},"$data.GeographyPolygon":function(b){return b?new $data.GeographyPolygon(b):b},"$data.GeographyMultiPoint":function(b){return b?new $data.GeographyMultiPoint(b):b},"$data.GeographyMultiLineString":function(b){return b?new $data.GeographyMultiLineString(b):b},"$data.GeographyMultiPolygon":function(b){return b?new $data.GeographyMultiPolygon(b):
b},"$data.GeographyCollection":function(b){return b?new $data.GeographyCollection(b):b},"$data.GeometryPoint":function(b){return b?new $data.GeometryPoint(b):b},"$data.GeometryLineString":function(b){return b?new $data.GeometryLineString(b):b},"$data.GeometryPolygon":function(b){return b?new $data.GeometryPolygon(b):b},"$data.GeometryMultiPoint":function(b){return b?new $data.GeometryMultiPoint(b):b},"$data.GeometryMultiLineString":function(b){return b?new $data.GeometryMultiLineString(b):b},"$data.GeometryMultiPolygon":function(b){return b?
new $data.GeometryMultiPolygon(b):b},"$data.GeometryCollection":function(b){return b?new $data.GeometryCollection(b):b},"$data.Guid":function(b){return b?$data.parseGuid(b).toString():b}},toDb:{"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,
"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Date":$data.Container.proxyConverter,"$data.DateTimeOffset":$data.Container.proxyConverter,"$data.Time":$data.Container.proxyConverter,"$data.String":$data.Container.proxyConverter,"$data.Boolean":$data.Container.proxyConverter,"$data.Blob":$data.Container.proxyConverter,"$data.Object":$data.Container.proxyConverter,"$data.Array":$data.Container.proxyConverter,"$data.ObjectID":function(b){if(b&&"string"===
typeof b)try{return new $data.ObjectID(b)}catch(a){try{return new $data.ObjectID((new Buffer(b,"base64")).toString("ascii"))}catch(c){return console.log(c),b}}else return b},"$data.GeographyPoint":function(b){return b?b.coordinates:b},"$data.GeographyLineString":$data.Container.proxyConverter,"$data.GeographyPolygon":$data.Container.proxyConverter,"$data.GeographyMultiPoint":$data.Container.proxyConverter,"$data.GeographyMultiLineString":$data.Container.proxyConverter,"$data.GeographyMultiPolygon":$data.Container.proxyConverter,
"$data.GeographyCollection":$data.Container.proxyConverter,"$data.GeometryPoint":function(b){return b?b.coordinates:b},"$data.GeometryLineString":$data.Container.proxyConverter,"$data.GeometryPolygon":$data.Container.proxyConverter,"$data.GeometryMultiPoint":$data.Container.proxyConverter,"$data.GeometryMultiLineString":$data.Container.proxyConverter,"$data.GeometryMultiPolygon":$data.Container.proxyConverter,"$data.GeometryCollection":$data.Container.proxyConverter,"$data.Guid":function(b){return b?
b.toString():b}}};
$C("$data.modelBinder.mongoDBModelBinderConfigCompiler",$data.modelBinder.ModelBinderConfigCompiler,null,{_addPropertyToModelBinderConfig:function(b,a){var c=this._query.context._storageModel.getStorageModel(b);b.memberDefinitions?b.memberDefinitions.getPublicMappedProperties().forEach(function(b){if(!c||c&&!c.Associations[b.name]&&!c.ComplexTypes[b.name])if(!c&&0>this._query.context.storageProvider.supportedDataTypes.indexOf(Container.resolveType(b.dataType)))a.selectModelBinderProperty(b.name),a.modelBinderConfig.$type=
Container.resolveType(b.dataType),a.modelBinderConfig.$selector=this._isoDataProvider?["json:"+b.name+".results","json:"+b.name]:"json:"+b.name,this._addPropertyToModelBinderConfig(Container.resolveType(b.dataType),a),a.popModelBinderProperty();else if(b.key&&a.addKeyField(b.computed?"_id":b.name),b.concurrencyMode===$data.ConcurrencyMode.Fixed)a.modelBinderConfig[b.name]={$selector:"json:__metadata",$source:"etag"};else{var e=Container.resolveType(b.dataType);a.modelBinderConfig[b.name]=e===$data.Array||
e===$data.Object?{$type:e,$source:b.name}:b.computed?"_id":b.name}},this):(a._binderConfig.$item=a._binderConfig.$item||{},a.modelBinderConfig=a._binderConfig.$item);c&&this._addComplexTypeProperties(c.ComplexTypes,a)},_addComplexType:function(b,a){if(b.ToType!==$data.Array)a.modelBinderConfig.$type=b.ToType,a.modelBinderConfig.$selector=this._isoDataProvider?["json:"+b.FromPropertyName+".results","json:"+b.FromPropertyName]:"json:"+b.FromPropertyName,this._addPropertyToModelBinderConfig(b.ToType,
a);else{var c=b.ToType,d=Container.resolveType(b.FromType.memberDefinitions.getMember(b.FromPropertyName).elementType);if(c===$data.Array&&d&&d.isAssignableTo&&d.isAssignableTo($data.Entity)){config={$type:$data.Array,$selector:"json:"+b.FromPropertyName,$item:{$type:d}};c=d.memberDefinitions.getPublicMappedProperties();for(d=0;d<c.length;d++)config.$item[c[d].name]={$type:c[d].type,$source:c[d].name};$data.typeSystem.extend(a.modelBinderConfig,config)}else c===$data.Array&&d===$data.ObjectID?$data.typeSystem.extend(a.modelBinderConfig,
{$type:$data.Array,$selector:"json:"+b.FromPropertyName,$item:{$type:$data.ObjectID,$value:function(a,b){return b}}}):$data.typeSystem.extend(a.modelBinderConfig,{$type:b.ToType,$source:b.FromPropertyName})}},_addComplexTypeProperties:function(b,a){var c=this;b.forEach(function(b){a.selectModelBinderProperty(b.FromPropertyName);c._addComplexType(b,a);a.popModelBinderProperty()},this)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a);if("$selector"in a.modelBinderConfig&&
0<a.modelBinderConfig.$selector.length)if(a.modelBinderConfig.$selector instanceof $data.Array){var c=a.modelBinderConfig.$selector[1];a.modelBinderConfig.$selector[0]=c+"."+b.selector.memberName+".results";a.modelBinderConfig.$selector[1]=c+"."+b.selector.memberName}else{var c=Container.resolveType(b.selector.memberDefinition.type),d=c===$data.Array&&b.selector.memberDefinition.elementType?Container.resolveType(b.selector.memberDefinition.elementType):c;d.memberDefinitions.getMember(b.selector.memberName)&&
(a.modelBinderConfig.$selector+="."+b.selector.memberName)}else(c=Container.resolveType(b.selector.memberDefinition.type),d=c===$data.Array&&b.selector.memberDefinition.elementType?Container.resolveType(b.selector.memberDefinition.elementType):void 0,c===$data.Array&&d&&d.isAssignableTo&&d.isAssignableTo($data.Entity))?this._addComplexType(b.selector.memberDefinition.storageModel.ComplexTypes[b.selector.memberDefinition.name],a):(a.modelBinderConfig.$source=b.selector.memberName,c!==$data.Array&&
(a.modelBinderConfig.$selector="json:"+b.selector.memberDefinition.name),a._binderConfig.$item===a.modelBinderConfig&&b.selector.memberDefinition.storageModel&&b.selector.memberDefinition.storageModel.ComplexTypes[b.selector.memberDefinition.name])?(a.modelBinderConfig.$selectorMemberInfo=a.modelBinderConfig.$selector,delete a.modelBinderConfig.$selector):delete a.modelBinderConfig.$source},VisitMemberInfoExpression:function(b,a){var c=Container.resolveType(b.memberDefinition.type),d=c===$data.Array&&
b.memberDefinition.elementType?Container.resolveType(b.memberDefinition.elementType):void 0;a.modelBinderConfig.$type=c;c===$data.Array&&d&&d.isAssignableTo&&d.isAssignableTo($data.Entity)?this._addComplexType(b.memberDefinition.storageModel.ComplexTypes[b.memberName],a):b.memberDefinition.storageModel&&b.memberName in b.memberDefinition.storageModel.ComplexTypes?this._addPropertyToModelBinderConfig(Container.resolveType(b.memberDefinition.type),a):a._binderConfig.$item===a.modelBinderConfig?a._binderConfig.$item=
{$type:a.modelBinderConfig.$type,$selector:a.modelBinderConfig.$selectorMemberInfo||a.modelBinderConfig.$selector,$source:b.memberDefinition.computed?"_id":b.memberName}:a.modelBinderConfig.$source=b.memberDefinition.computed?"_id":b.memberName}});
$C("$data.storageProviders.mongoDB.mongoDBProjectionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b,a,c){this.provider=b;this.lambdaPrefix=a;c&&(this.compiler=c,this.includes=c.includes,this.mainEntitySet=c.mainEntitySet)},compile:function(b,a){this.Visit(b,a);delete a.current;delete a.complexType},VisitProjectionExpression:function(b,a){this.Visit(b.selector,a)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitObjectLiteralExpression:function(b,
a){this.hasObjectLiteral=!0;b.members.forEach(function(b){this.Visit(b,a)},this)},VisitObjectFieldExpression:function(b,a){this.Visit(b.expression,a)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitEntityExpression:function(b,a){a.includeOptions&&!a.includeOptions.fields&&(a.include.full=!0);delete a.include;delete a.includeOptions;this.Visit(b.source,a)},VisitEntitySetExpression:function(b,
a){b.source instanceof $data.Expressions.EntityExpression&&this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(b,a){this.includes=this.includes||[];for(var c=(a.include?a.include.name+"."+b.associationInfo.FromPropertyName:b.associationInfo.FromPropertyName).split("."),d=null,e=this.mainEntitySet.entityContext._storageModel.getStorageModel(this.mainEntitySet.createNew),f=0;f<c.length;f++){d=d?d+
("."+c[f]):c[f];if(e=e.Associations[c[f]]){var g=this.includes.filter(function(a){return a.name==d},this);a.include&&f<c.length-1&&(a.include.options.fields||(a.include.options.fields={_id:1}),a.include.options.fields[c[f+1]]=1);g.length?(a.includeOptions=g[0].options,a.include=g[0],g[0].mapped=!0):(g={name:d,type:e.ToType,from:e.FromType,query:{},options:{},mapped:!0},a.includeOptions=g.options,a.include=g,a.include.options.fields={_id:1},a.include.options.fields[e.ToPropertyName]=1,this.includes.push(g));
a.options.fields||(a.options.fields={_id:1});a.options.fields[c[0]]=1;e.ReferentialConstraint.forEach(function(b){for(var c in b)a.options.fields[b[c]]=1})}else Guard.raise(new Exception("The given include path is invalid: "+b.associationInfo.FromPropertyName+", invalid point: "+d));e=this.mainEntitySet.entityContext._storageModel.getStorageModel(e.ToType)}},VisitMemberInfoExpression:function(b,a){(a.includeOptions||a.options).fields||((a.includeOptions||a.options).fields={_id:1});a.current=b.memberName;
a.complexType?(delete (a.includeOptions||a.options).fields[a.complexType],(a.includeOptions||a.options).fields[a.complexType+"."+a.current]=1,delete a.complexType):(a.includeOptions||a.options).fields[b.memberName]||((a.includeOptions||a.options).fields[b.memberName]=1);delete a.includeOptions;delete a.include},VisitConstantExpression:function(){}});
$C("$data.storageProviders.mongoDB.mongoDBFilterCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b,a,c){this.provider=b;this.lambdaPrefix=a;c&&(this.compiler=c,this.includes=c.includes,this.mainEntitySet=c.mainEntitySet)},compile:function(b,a){a.cursor||(a.query={},a.cursor=a.query);this.Visit(b,a);if(a.query.$and){for(var c=a.query.$and,d={},e=!0,f=0;f<c.length;f++){var g=c[f],j;for(j in g){if(d[j]){e=!1;break}d[j]=g[j]}if(!e)break}e&&(a.query=d)}this.compiler&&(this.compiler.includes=
this.includes)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a);if(b.expression&&b.expression.nodeType===$data.Expressions.ExpressionType.Constant)if(a.value=b.expression.value,a.queryField=a.field=$data.Guid.NewGuid(),!0===a.value&&(a.value=null),a.cursor instanceof Array){var c={};c[a.queryField]=a.value;a.cursor.push(c)}else a.cursor[a.queryField]=a.value},VisitUnaryExpression:function(b,a){a.unary=b.nodeType;this.Visit(b.operand,a)},_constExpressionFilter:function(b,a){if(b.left&&
b.left.nodeType===$data.Expressions.ExpressionType.Constant&&b.right&&0<=[$data.Expressions.ExpressionType.Or,$data.Expressions.ExpressionType.And].indexOf(b.nodeType))if(a.value=b.left.value,a.queryField=a.field=$data.Guid.NewGuid(),!0===a.value&&(a.value=null),a.cursor instanceof Array){var c={};c[a.queryField]=a.value;a.cursor.push(c)}else a.cursor[a.queryField]=a.value},VisitSimpleBinaryExpression:function(b,a){switch(b.nodeType){case $data.Expressions.ExpressionType.Or:var c=a.cursor;if(a.cursor instanceof
Array){var d=a.unary===$data.Expressions.ExpressionType.Not?{$nor:[]}:{$or:[]};a.cursor.push(d);a.cursor=d[a.unary===$data.Expressions.ExpressionType.Not?"$nor":"$or"]}else a.cursor[a.unary===$data.Expressions.ExpressionType.Not?"$nor":"$or"]=[],a.cursor=a.cursor[a.unary===$data.Expressions.ExpressionType.Not?"$nor":"$or"];a.unary===$data.Expressions.ExpressionType.Not&&(a.unary=void 0);this.Visit(b.left,a);this.Visit(b.right,a);this._constExpressionFilter(b,a);if(c instanceof Array)for(d=0;d<c.length;d++){var e=
c[d];e.$or&&(0==e.$or.length?delete e.$or:1==e.$or.length&&($data.typeSystem.extend(e,e.$or[0]),delete e.$or))}else c.$or&&(0==c.$or.length?delete c.$or:1==c.$or.length&&($data.typeSystem.extend(c,c.$or[0]),delete c.$or));a.cursor=c;break;case $data.Expressions.ExpressionType.And:c=a.cursor;a.cursor instanceof Array?(d={$and:[]},a.cursor.push(d),a.cursor=d.$and):(a.cursor.$and=[],a.cursor=a.cursor.$and);this.Visit(b.left,a);this.Visit(b.right,a);this._constExpressionFilter(b,a);if(c instanceof Array)for(d=
0;d<c.length;d++)e=c[d],e.$and&&(0==e.$and.length?delete e.$and:1==e.$and.length&&($data.typeSystem.extend(e,e.$and[0]),delete e.$and));else c.$and&&(0==c.$and.length?delete c.$and:1==c.$and.length&&($data.typeSystem.extend(c,c.$and[0]),delete c.$and));a.cursor=c;break;case $data.Expressions.ExpressionType.Equal:case $data.Expressions.ExpressionType.EqualTyped:this.Visit(b.left,a);this.Visit(b.right,a);a.queryField=a.field;!a.complexType&&a.entityType&&a.entityType.memberDefinitions.getMember(a.field).computed&&
(delete a.query[a.field],a.queryField="_id");c=a.value;a.entityType&&a.entityType.memberDefinitions?c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.complexType?a.lastField:a.field).type))](c):a.valueType&&(c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.valueType))](c));a.value=c;if(a.fieldOperation)a.unary===$data.Expressions.ExpressionType.Not&&(d={$not:a.cursor[a.queryField]},a.cursor[a.queryField]=
d);else if(a.cursor instanceof Array?(e={},e[a.queryField]=a.unary===$data.Expressions.ExpressionType.Not?{$ne:a.value}:a.value,a.cursor.push(e)):a.cursor[a.queryField]=a.unary===$data.Expressions.ExpressionType.Not?{$ne:a.value}:a.value,a.options&&a.options.fields&&(a.options.fields[a.queryField]=1),a.unary===$data.Expressions.ExpressionType.Not)a.unary=void 0;break;case $data.Expressions.ExpressionType.In:this.Visit(b.left,a);this.Visit(b.right,a);a.queryField=a.field;!a.complexType&&a.entityType&&
a.entityType.memberDefinitions.getMember(a.field).computed&&(delete a.query[a.field],a.queryField="_id");c=a.value;if(c instanceof Array){c=c.map(function(a){return a.value});for(d=0;d<c.length;d++)a.entityType&&a.entityType.memberDefinitions?c[d]=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.complexType?a.lastField:a.field).type))](c[d]):a.valueType&&(c[d]=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.valueType))](c[d]))}a.value=
c;a.cursor instanceof Array?(e={},e[a.queryField]={},a.entityType&&a.entityType===$data.Array?e[a.queryField]=a.unary===$data.Expressions.ExpressionType.Not?{$not:a.value}:a.value:e[a.queryField][a.unary===$data.Expressions.ExpressionType.Not?"$nin":b.resolution.mapTo]=a.value,a.cursor.push(e)):(a.cursor[a.queryField]={},a.entityType&&a.entityType===$data.Array?a.cursor[a.queryField]=a.unary===$data.Expressions.ExpressionType.Not?{$not:a.value}:a.value:a.cursor[a.queryField][a.unary===$data.Expressions.ExpressionType.Not?
"$nin":b.resolution.mapTo]=a.value);a.options&&a.options.fields&&(a.options.fields[a.queryField]=1);a.unary===$data.Expressions.ExpressionType.Not&&(a.unary=void 0);break;default:this.Visit(b.left,a);this.Visit(b.right,a);a.queryField=a.field;if(Array.isArray(a.cursor)&&a.cursor[0]&&a.cursor[0][a.queryField]&&(a.cursor[0][a.queryField].$near||a.cursor[0][a.queryField].$nearSphere||a.cursor[0][a.queryField].$within))a.query=a.cursor[0],a.cursor=a.cursor[0];if((d=a.cursor[0]||a.cursor)&&d[a.queryField]&&
d[a.queryField].$within)break;!a.complexType&&a.entityType&&a.entityType.memberDefinitions.getMember(a.field).computed&&(delete a.query[a.field],a.queryField="_id");c=a.value;a.entityType&&a.entityType.memberDefinitions?c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.entityType.memberDefinitions.getMember(a.complexType?a.lastField:a.field).type))](c):a.valueType&&(c=this.provider.fieldConverter.toDb[Container.resolveName(Container.resolveType(a.valueType))](c));a.value=
c;a.cursor instanceof Array?(e={},e[a.queryField]={},e[a.queryField][b.resolution.mapTo]=a.value,a.cursor.push(e)):(a.cursor[a.queryField]={},a.cursor[a.queryField][b.resolution.mapTo]=a.value);a.options&&a.options.fields&&(a.options.fields[a.queryField]=1)}delete a.fieldOperation;delete a.complexType;delete a.association;delete a.field;delete a.value},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitAssociationInfoExpression:function(b,a){this.includes=
this.includes||[];for(var c=(a.include?a.include.name+"."+b.associationInfo.FromPropertyName:b.associationInfo.FromPropertyName).split("."),d=null,e=this.mainEntitySet.entityContext._storageModel.getStorageModel(this.mainEntitySet.createNew),f=0;f<c.length;f++){d=d?d+("."+c[f]):c[f];if(e=e.Associations[c[f]]){var g=this.includes.filter(function(a){return a.name==d},this);a.include&&f<c.length-1&&(a.include.options.fields||(a.include.options.fields={_id:1}),a.include.options.fields[c[f+1]]=1);g.length?
(a.includeOptions=g[0].options,a.include=g[0]):(g={name:d,type:e.ToType,from:e.FromType,query:{},options:{},mapped:!1},a.includeOptions=g.options,a.include=g,a.include.options.fields={_id:1},a.include.options.fields[e.ToPropertyName]=1,this.includes.push(g));a.options.fields||(a.options.fields={_id:1});a.options.fields[c[0]]=1;e.ReferentialConstraint.forEach(function(b){for(var c in b)a.options.fields[b[c]]=1});a.full=!0;a.mainCursor=a.cursor;a.cursor=a.include.query;a.entityType=e.ToType}else Guard.raise(new Exception("The given include path is invalid: "+
b.associationInfo.FromPropertyName+", invalid point: "+d));e=this.mainEntitySet.entityContext._storageModel.getStorageModel(e.ToType)}},VisitMemberInfoExpression:function(b,a){a.field=a.complexType&&a.field?a.field+"."+b.memberName:b.memberName;a.complexType&&(a.lastField=b.memberName)},VisitComplexTypeExpression:function(b,a){a.complexType=!0;this.Visit(b.source,a);this.Visit(b.selector,a);a.entityType=b.entityType},VisitQueryParameterExpression:function(b,a){a.data+=this.provider.fieldConverter.toDb[b.type](b.value)},
_fieldOperation:function(b,a){a.fieldOperation=!0;var c,d;switch(b){case "contains":c="$regex";d=a.value.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");break;case "startsWith":c="$regex";d="^"+a.value.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");break;case "endsWith":c="$regex",d=a.value.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+"$"}return{opMapTo:c,opValue:d}},VisitEntityFieldOperationExpression:function(b,a){Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);this.Visit(b.source,
a);var c=b.operation.memberDefinition,d=c.mapTo||c.name,e=0;(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[e++]}).forEach(function(b){this.Visit(b,a)},this);d=this._fieldOperation(d,a);c=d.opMapTo;d=d.opValue;a.unary===$data.Expressions.ExpressionType.Not&&(d="^((?!"+d+").)*$");a.options.fields&&(a.options.fields[a.field]=1);if(!a.include&&c&&d)if(a.cursor instanceof Array){var f={};f[a.field]={};f[a.field][c]=d;a.cursor.push(f)}else a.cursor[a.field]=
{},a.cursor[a.field][c]=d;a.complexType&&(delete a.complexType,delete a.field)},VisitConstantExpression:function(b,a){var c=Container.resolveName(b.type);a.valueType=c;a.value=b.value;if((c=Array.isArray(a.cursor)?a.cursor.filter(function(b){return"undefined"!==typeof b[a.field]})[0]:a.cursor)&&c[a.field]&&c[a.field].$within)c=c[a.field],c.$within.$center?c.$within.$center=[c.$within.$center,a.value]:c.$within.$centerSphere&&(c.$within.$centerSphere=[c.$within.$centerSphere,a.value])},VisitEntityExpression:function(b,
a){a.entityType=b.entityType;a.mainCursor&&(a.cursor=a.mainCursor,delete a.include);this.Visit(b.source,a)},VisitEntitySetExpression:function(b,a){this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(b.selector,a),a.data+="/")},_frameOperation:function(b,a,c,d,e){for(var f=this,g=[],c=0;c<a.length;c++){var j=a[c];if(j&&j.value instanceof $data.Queryable){var i=new b.frameType(j.value.expression),i=(new $data.Expressions.QueryExpressionCreator(j.value.entityContext)).Visit(i),
l=function(a,b,c){if(a._expressionType===$data.Expressions.AssociationInfoExpression){var c=c+("."+a.associationInfo.FromPropertyName),d=b.entitySet.entityContext._storageModel.getStorageModel(b.defaultType).Associations[a.associationInfo.FromPropertyName];if(d){var i=b.includes.filter(function(a){return a.name==c},this);0==i.length&&(i={name:c,type:d.ToType,from:d.FromType,query:{},options:{},mapped:!1},i.options.fields={_id:1},i.options.fields[d.ToPropertyName]=1,b.includes.push(i));b.context.options.fields||
(b.context.options.fields={_id:1});d.ReferentialConstraint.forEach(function(a){for(var b in a);})}else Guard.raise(new Exception("The given include path is invalid: "+a.associationInfo.FromPropertyName+", invalid point: "+c));b.defaultType=d.ToType}else a._expressionType===$data.Expressions.FrameOperationExpression?g.push(function(){var d=a.operation.memberDefinition,e=0,g=(d.parameters||[{name:"@expression"}]).map(function(b){return"@expression"===b.name?a.source:a.parameters[e++]});f._frameOperation(d,
g,a,{entitySet:j.value.entityContext._entitySetReferences[j.value.expression.elementType.name],defaultType:j.value.expression.elementType,context:b.context,includes:f.includes},c)}):a._expressionType===$data.Expressions.MemberInfoExpression&&(c=e,b.defaultType=j.value.expression.elementType);a.source&&(c=l(a.source,b,c));a.selector&&(c=l(a.selector,b,c));a.expression&&(c=l(a.expression,b,c));a.left&&(c=l(a.left,b,c));a.right&&(c=l(a.right,b,c));return c};l(i,{entitySet:j.value.entityContext._entitySetReferences[j.value.expression.elementType.name],
defaultType:j.value.expression.elementType,context:d.context?d.context:d,includes:this.includes},e,0)}}g.forEach(function(a){a()})},VisitFrameOperationExpression:function(b,a){this.Visit(b.source,a);Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);var c=b.operation.memberDefinition,d=0,e=(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[d++]});this._frameOperation(c,e,b,a,a.include.name)}});
$C("$data.storageProviders.mongoDB.mongoDBOrderCompiler",$data.storageProviders.mongoDB.mongoDBFilterCompiler,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitOrderExpression:function(b,a){a.data="";this.Visit(b.selector,a);(a.include||a).options.sort||((a.include||a).options.sort={});(a.include||a).options.sort[a.includeSort||a.data]=b.nodeType==$data.Expressions.ExpressionType.OrderByDescending?-1:1;delete a.data;delete a.include;delete a.includeSort;delete a.includeOptions},
VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitEntityFieldExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);a.data&&(a.data+=".");this.Visit(b.selector,a)},VisitEntitySetExpression:function(b,a){b.selector instanceof $data.Expressions.AssociationInfoExpression&&(this.Visit(b.source,a),this.Visit(b.selector,a))},VisitAssociationInfoExpression:function(b,a){this.includes=this.includes||
[];for(var c=(a.include?a.include.name+"."+b.associationInfo.FromPropertyName:b.associationInfo.FromPropertyName).split("."),d=null,e=this.mainEntitySet.entityContext._storageModel.getStorageModel(this.mainEntitySet.createNew),f=0;f<c.length;f++){d=d?d+("."+c[f]):c[f];if(e=e.Associations[c[f]]){var g=this.includes.filter(function(a){return a.name==d},this);a.include&&f<c.length-1&&(a.include.options.sort||(a.include.options.sort={}),a.includeSort+=c[f]);g.length?(a.includeOptions=g[0].options,a.include=
g[0],a.includeSort=d):(g={name:d,type:e.ToType,from:e.FromType,query:{},options:{},mapped:!1},a.includeOptions=g.options,a.include=g,a.includeSort=d,this.includes.push(g))}else Guard.raise(new Exception("The given include path is invalid: "+b.associationInfo.FromPropertyName+", invalid point: "+d));e=this.mainEntitySet.entityContext._storageModel.getStorageModel(e.ToType)}},VisitEntityExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a)},VisitMemberInfoExpression:function(b,a){void 0!==
a.includeSort?(a.includeSort&&(a.includeSort+="."),a.includeSort+=b.memberDefinition.computed?"_id":b.memberName):(a.data&&(a.data+="."),a.data+=b.memberDefinition.computed?"_id":b.memberName)}});
$C("$data.storageProviders.mongoDB.mongoDBPagingCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b){this.provider=b},compile:function(b,a){this.Visit(b,a)},VisitPagingExpression:function(b,a){var c={data:0};this.Visit(b.amount,c);switch(b.nodeType){case $data.Expressions.ExpressionType.Skip:a.options.skip=c.data;break;case $data.Expressions.ExpressionType.Take:a.options.limit=c.data;break;default:Guard.raise("Not supported nodeType")}},VisitConstantExpression:function(b,
a){a.data+=b.value}});
$C("$data.storageProviders.mongoDB.mongoDBFunctionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(b,a,c){this.provider=b;c&&(this.compiler=c,this.includes=c.includes,this.mainEntitySet=c.mainEntitySet)},compile:function(b,a){this.Visit(b,a)},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a)},VisitUnaryExpression:function(b,a){a.data+=this.provider.supportedBinaryOperators[b.resolution.name].mapTo;a.data+="(";this.Visit(b.operand,a);a.data+=")"},
VisitSimpleBinaryExpression:function(b,a){b.resolution.reverse?(a.data+="(",this.Visit(b.right,a),a.data+=this.provider.supportedBinaryOperators[b.resolution.name].mapTo,this.Visit(b.left,a),b.resolution.rightValue&&(a.data+=b.resolution.rightValue)):(a.data+="(",this.Visit(b.left,a),a.data+=this.provider.supportedBinaryOperators[b.resolution.name].mapTo,this.Visit(b.right,a));a.data+=")"},VisitConstantExpression:function(b,a){var c=Container.resolveType(b.type),c=Container.resolveName(c);a.data+=
this.provider.fieldConverter.toDb[c](b.value)},VisitMemberInfoExpression:function(b,a){var c=a.data.slice(a.data.lastIndexOf("(")+1);a.data=Container.resolveType(b.memberDefinition.type)==$data.ObjectID?a.data+(b.memberDefinition.computed?"_id ? "+c+"_id.toString() : "+c+"_id)":b.memberName+" ? "+c+b.memberName+".toString() : "+c+b.memberName+")"):a.data+(b.memberDefinition.computed?"_id)":b.memberName+")")},VisitComplexTypeExpression:function(b,a){this.Visit(b.source,a);this.Visit(b.selector,a);
a.data+="."},VisitEntityExpression:function(b,a){this.Visit(b.source,a);a.entityType=b.entityType;b.selector.lambda&&(a.data+="("+b.selector.lambda+".",a.lambda=b.selector.lambda)},VisitEntitySetExpression:function(b,a){this.Visit(b.source,a);b.selector instanceof $data.Expressions.AssociationInfoExpression&&this.Visit(b.selector,a)},VisitObjectLiteralExpression:function(b,a){a.data+="{ ";for(var c=0;c<b.members.length;c++){var d=b.members[c];0<c&&(a.data+=", ");this.Visit(d,a)}a.data+=" }"},VisitObjectFieldExpression:function(b,
a){a.data+=b.fieldName+": ";this.Visit(b.expression,a)},VisitAssociationInfoExpression:function(b,a){a.data+=b.associationInfo.FromPropertyName+"."},VisitEntityFieldOperationExpression:function(b,a){Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);var c=b.operation.memberDefinition,c=this.provider.supportedFieldOperations[c.name];c.propertyFunction&&(this.Visit(b.source,a),a.data+=".");a.data+=c.mapTo||c.name;var d=0;(c.parameters||[]).map(function(a){return a.name===
"@expression"?b.source:b.parameters[d++]}).forEach(function(b,c){if(b){if(c>0)a.data=a.data+",";this.Visit(b,a)}},this);a.data+=c.rightValue||""},VisitFrameOperationExpression:function(b,a){this.Visit(b.source,a);Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);var c=b.operation.memberDefinition;a.data+=c.mapTo||c.name;a.data+="(";for(var d=0,e=(c.parameters||[{name:"@expression"}]).map(function(a){return"@expression"===a.name?b.source:b.parameters[d++]}),
f=0;f<e.length;f++){var g=e[f];if(g&&g.value instanceof $data.Queryable){var j=new c.frameType(g.value.expression),g=(new $data.Expressions.QueryExpressionCreator(g.value.entityContext)).Visit(j),j={data:""};(new this.constructor(this.provider,!0)).compile(g,j);a.data+="function("+j.lambda+"){ return "+j.data+"; }"}else a.data+="function(){ return true; }"}a.data+="))"}});
$C("$data.storageProviders.mongoDB.mongoDBCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){this.context={};this.provider={};this.includes=[];this.mainEntitySet=null},compile:function(b){this.provider=b.context.storageProvider;this.context=b.context;this.mainEntitySet=b.context.getEntitySetFromElementType(b.defaultType);this.query=b;b.find={query:{},options:{}};this.Visit(b.expression,b.find);b.includes=this.includes;b.modelBinderConfig={};(new $data.modelBinder.mongoDBModelBinderConfigCompiler(b,
this.includes.filter(function(a){return a.mapped}),!0)).Visit(b.expression);delete b.find.field;delete b.find.value;delete b.find.data;delete b.find.stack;delete b.find.or;return b},VisitOrderExpression:function(b,a){this.Visit(b.source,a);(new $data.storageProviders.mongoDB.mongoDBOrderCompiler(this.provider,null,this)).compile(b,a)},VisitPagingExpression:function(b,a){this.Visit(b.source,a);(new $data.storageProviders.mongoDB.mongoDBPagingCompiler).compile(b,a)},VisitFilterExpression:function(b,
a){this.Visit(b.source,a);var c=new $data.storageProviders.mongoDB.mongoDBFilterCompiler(this.provider,null,this);a.data="";c.compile(b.selector,a);this.includes&&this.includes.length&&(a.data="",a.lambda="",(new $data.storageProviders.mongoDB.mongoDBFunctionCompiler({supportedBinaryOperators:{equal:{mapTo:" == ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqual:{mapTo:" != ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,
$data.Expressions.OrderExpression]},equalTyped:{mapTo:" === ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqualTyped:{mapTo:" !== ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThan:{mapTo:" > ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThanOrEqual:{mapTo:" >= ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,
$data.Expressions.OrderExpression]},lessThan:{mapTo:" < ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThenOrEqual:{mapTo:" <= ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},or:{mapTo:" || ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},and:{mapTo:" && ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},
"in":{mapTo:".indexOf(",allowedIn:[$data.Expressions.FilterExpression],rightValue:") > -1",reverse:!0}},supportedUnaryOperators:{not:{mapTo:"!"}},supportedFieldOperations:{contains:{mapTo:"$data.StringFunctions.contains(",rightValue:")",dataType:"boolean",parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},startsWith:{mapTo:"$data.StringFunctions.startsWith(",rightValue:")",dataType:"boolean",parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",
dataType:"string"}]},endsWith:{mapTo:"$data.StringFunctions.endsWith(",rightValue:")",dataType:"boolean",parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]}},fieldConverter:{toDb:$data.typeSystem.extend({"$data.ObjectID":function(a){return a?'atob("'+a.toString()+'")':a}},$data.InMemoryConverter.escape)}},null,this)).compile(b.selector,a),a.filter=new Function(a.lambda,"return "+a.data+";"),a.data="",a.lambda="")},VisitProjectionExpression:function(b,a){this.Visit(b.source,
a);(new $data.storageProviders.mongoDB.mongoDBProjectionCompiler(this.provider,null,this)).compile(b,a)},VisitIncludeExpression:function(b,a){this.Visit(b.source,a);this.includes=this.includes||[];for(var c=b.selector.value.split("."),d=null,e=this.mainEntitySet.entityContext._storageModel.getStorageModel(this.mainEntitySet.createNew),f=0;f<c.length;f++){d=d?d+("."+c[f]):c[f];if(e=e.Associations[c[f]]){var g=this.includes.filter(function(a){return a.name==d},this);g.length?g[0].mapped=!0:this.includes.push({name:d,
type:e.ToType,from:e.FromType,query:{},options:{},mapped:!0})}else Guard.raise(new Exception("The given include path is invalid: "+b.selector.value+", invalid point: "+d));e=this.mainEntitySet.entityContext._storageModel.getStorageModel(e.ToType)}},VisitInlineCountExpression:function(b,a){this.Visit(b.source,a);this.query.withInlineCount="allpages"==b.selector?!0:!1}});
$C("$data.storageProviders.mongoDB.mongoDBProvider",$data.StorageProviderBase,null,{constructor:function(b,a){this.driver=$data.mongoDBDriver;this.context=a;this.providerConfiguration=$data.typeSystem.extend({dbCreation:$data.storageProviders.DbCreationType.DropTableIfChanged,address:"127.0.0.1",port:27017,serverOptions:{},databaseName:"test"},b);if(this.providerConfiguration.server&&("string"===typeof this.providerConfiguration.server&&(this.providerConfiguration.server=[{address:this.providerConfiguration.server.split(":")[0]||
"127.0.0.1",port:this.providerConfiguration.server.split(":")[1]||27017}]),this.providerConfiguration.server instanceof Array||(this.providerConfiguration.server=[this.providerConfiguration.server]),1==this.providerConfiguration.server.length))this.providerConfiguration.address=this.providerConfiguration.server[0].address||"127.0.0.1",this.providerConfiguration.port=this.providerConfiguration.server[0].port||27017,delete this.providerConfiguration.server;this.context&&this.context._buildDbType_generateConvertToFunction&&
this.buildDbType_generateConvertToFunction&&(this.context._buildDbType_generateConvertToFunction=this.buildDbType_generateConvertToFunction);this.context&&this.context._buildDbType_modifyInstanceDefinition&&this.buildDbType_modifyInstanceDefinition&&(this.context._buildDbType_modifyInstanceDefinition=this.buildDbType_modifyInstanceDefinition)},_getServer:function(){if(this.providerConfiguration.server){for(var b=[],a=0;a<this.providerConfiguration.server.length;a++){var c=this.providerConfiguration.server[a];
b.push(new this.driver.Server(c.address,c.port,c.serverOptions))}return new this.driver.ReplSetServers(b)}return this.driver.Server(this.providerConfiguration.address,this.providerConfiguration.port,this.providerConfiguration.serverOptions)},initializeStore:function(b){var a=this,b=$data.typeSystem.createCallbackSetting(b);(new this.driver.Db(this.providerConfiguration.databaseName,this._getServer(),{safe:!1})).open(function(c,d){if(c)b.error(c);else{var e=function(c,d){var e=0,i=function(c,d){var f=
function(){0>=--e&&(b.success(a.context),c.close())};if(d){var g=a.context._storageModel.getStorageModel(d.createNew).indices;g&&"function"===typeof a._createIndices?a._createIndices(c,d,g,f):f()}else f()},l;for(l in a.context._entitySetReferences)a.context._entitySetReferences.hasOwnProperty(l)&&e++;l=Object.keys(a.context._entitySetReferences);if(!l.length)return i(d);l.forEach(function(c){a.context._entitySetReferences.hasOwnProperty(c)&&d.collectionNames({namesOnly:!0},function(e,f){f=f.map(function(a){return a.slice(a.lastIndexOf(".")+
1)});switch(a.providerConfiguration.dbCreation){case $data.storageProviders.DbCreationType.DropAllExistingTables:0<=f.indexOf(a.context._entitySetReferences[c].tableName)?d.dropCollection(a.context._entitySetReferences[c].tableName,function(e){e?b.error(e):a.context._entitySetReferences[c].tableOptions?d.createCollection(a.context._entitySetReferences[c].tableName,a.context._entitySetReferences[c].tableOptions,function(e){e?b.error(e):i(d,a.context._entitySetReferences[c])}):i(d,a.context._entitySetReferences[c])}):
0>f.indexOf(a.context._entitySetReferences[c].tableName)&&a.context._entitySetReferences[c].tableOptions?d.createCollection(a.context._entitySetReferences[c].tableName,a.context._entitySetReferences[c].tableOptions,function(e){e?b.error(e):i(d,a.context._entitySetReferences[c])}):i(d,a.context._entitySetReferences[c]);break;default:0>f.indexOf(a.context._entitySetReferences[c].tableName)&&a.context._entitySetReferences[c].tableOptions?d.createCollection(a.context._entitySetReferences[c].tableName,
a.context._entitySetReferences[c].tableOptions,function(e){e?b.error(e):i(d,a.context._entitySetReferences[c])}):i(d,a.context._entitySetReferences[c])}})})};a.providerConfiguration.username?d.authenticate(a.providerConfiguration.username,a.providerConfiguration.password||"",function(a,c){a?b.error(a):c&&e(a,d)}):e(c,d)}})},_connected:function(b,a,c,d,e){var f=!1;e.ReferentialConstraint.forEach(function(e){d&&e[c]&&void 0!=b[e[c]]&&(f=JSON.stringify(b[e[c]])==JSON.stringify(void 0!=d[e[a]]?d[e[a]]:
d._id))});return f},_compile:function(b){return(new $data.storageProviders.mongoDB.mongoDBCompiler).compile(b)},getTraceString:function(b){return this._compile(b)},executeQuery:function(b,a){var c=this,a=$data.typeSystem.createCallbackSetting(a),d=b.context.getEntitySetFromElementType(b.defaultType);this._compile(b);(new this.driver.Db(this.providerConfiguration.databaseName,this._getServer(),{safe:!1})).open(function(e,f){if(e)a.error(e);else{var g=new c.driver.Collection(f,d.tableName),j=b.includes&&
b.includes.length?b.includes.map(function(a){delete a.options.fields;return{name:a.name,type:a.type,from:a.from,collection:new c.driver.Collection(f,b.context.getEntitySetFromElementType(a.type).tableName),query:a.query||{},options:a.options||{}}}):null;b.context=c.context;var i=b.find,l=function(c,d){c?a.error(c):(b.find.filter&&(d=d.filter(b.find.filter)),b.rawDataList=b.expression.nodeType===$data.Expressions.ExpressionType.Count||b.expression.nodeType===$data.Expressions.ExpressionType.BatchDelete?
d instanceof Array?[{cnt:d.length}]:[{cnt:d}]:d,a.success(b),f.close())},h=function(){switch(b.expression.nodeType){case $data.Expressions.ExpressionType.BatchDelete:g.remove(i.query,{safe:!0},l);break;case $data.Expressions.ExpressionType.Count:if(!j||!j.length){g.find(i.query,i.options).count(l);break}default:i.full&&delete i.options.fields;var d=function(){g.find(i.query,i.options).toArray(function(b,d){if(b)a.error(b);else{var e=function(b){b.collection.find({},b.options).toArray(function(f,g){if(f)a.error(f);
else{for(var i=b.name.split("."),h=i[i.length-1],k=c.context._storageModel.getStorageModel(b.from).Associations[h],v=function(a){if("0..1"==k.FromMultiplicity&&"*"==k.ToMultiplicity){var b=g.filter(function(b){return c._connected(b,k.ToPropertyName,k.To,a,k)});a[h]=b}else"*"==k.FromMultiplicity&&"0..1"==k.ToMultiplicity?(b=g.filter(function(b){return null===a[k.FromPropertyName]?!1:c._connected(a,k.FromPropertyName,k.From,b,k)})[0],a[h]=b||a[h]):"1"==k.FromMultiplicity&&"0..1"==k.ToMultiplicity?(b=
g.filter(function(b){return c._connected(b,k.ToPropertyName,k.To,a,k)})[0],a[h]=b||a[h]):"0..1"==k.FromMultiplicity&&"1"==k.ToMultiplicity&&(b=g.filter(function(b){return c._connected(a,k.FromPropertyName,k.From,b,k)})[0],a[h]=b||a[h])},m=function(a,b){for(var c=!0,d=0;d<b.length;d++){"undefined"!==typeof a[b[d]]&&(a=a[b[d]]);if(Array.isArray(a)&&a.length)for(var c=!1,e=0;e<a.length;e++)d<b.length-1?m(a[e],b.slice(d)):v(a[e]);if(!c)break}c&&v(a)},o=0;o<d.length;o++)m(d[o],i.slice(0,-1));if(b.options.sort){var u=
Object.keys(b.options.sort),x=u.map(function(a){return new Function("it","return it."+a+";")});d.sort(function(a,c){for(var d,e=0,f=u.length;e<f;e++){d=x[e](a);var g=x[e](c);d=1==b.options.sort[u[e]]?d===g?0:d>g||null===g?1:-1:d===g?0:d<g||null===d?1:-1;if(0!==d)break}return d})}j&&j.length?e(j.shift()):l(f,d)}})};j&&j.length?e(j.shift()):l(b,d)}})};b.withInlineCount?g.find(i.query,{}).count(function(c,f){e?a.error(e):(b.__count=f,d())}):d()}};c.providerConfiguration.username?f.authenticate(c.providerConfiguration.username,
c.providerConfiguration.password,function(b,c){b?a.error(b):c?h():a.error("Authentication failed")}):h()}})},_typeFactory:function(b,a,c){if(a&&a.$ref&&a.$id||null==a||void 0==a)return a;b=Container.resolveName(b);return c&&c[b]?c[b](a):new (Container.resolveType(b))(a)},_saveCollections:function(b,a){var c=this,d=0,e=this._getServer(),f=0,g=function(a){0>=--f&&a()},j=function(a,e,f){for(var g=[],j=0;j<e.insertAll.length;j++){for(var h=e.insertAll[j],p=Container.resolveType(h.type).memberDefinitions.getPublicMappedProperties(),
n=0;n<p.length;n++){var k=p[n];if(k.concurrencyMode===$data.ConcurrencyMode.Fixed)h.data[k.name]=0;else if(k.computed)h.data._id=c._typeFactory(k.type,h.data._id,c.fieldConverter.toDb);else if(Container.resolveType(k.type)===$data.Array&&k.elementType&&Container.resolveType(k.elementType)===$data.ObjectID){h.data[k.name]=c._typeFactory(k.type,h.data[k.name],c.fieldConverter.toDb);var r=h.data[k.name];if(r)for(var m=0;m<r.length;m++)r[m]=c._typeFactory(k.elementType,r[m],c.fieldConverter.toDb)}else h.data[k.name]=
c._typeFactory(k.type,h.data[k.name],c.fieldConverter.toDb),h.data[k.name]&&h.data[k.name].initData&&(h.data[k.name]=h.data[k.name].initData)}g.push(h.data)}f.insert(g,{safe:!0},function(g,j){if(g)b.error(g),a.close();else{for(var h=0;h<j.length;h++)for(var k=j[h],m=e.insertAll[h],w=Container.resolveType(m.type).memberDefinitions.getPublicMappedProperties(),t=0;t<w.length;t++){var n=w[t];n.inverseProperty||(m.entity[n.name]=c._typeFactory(n.type,k[n.computed?"_id":n.name],c.fieldConverter.fromDb))}d+=
j.length;e.removeAll&&e.removeAll.length?l(a,e,f):e.updateAll&&e.updateAll.length?i(a,e,f):o(a,d)}})},i=function(a,e,j){f=e.updateAll.length;for(var h=0;h<e.updateAll.length;h++){for(var i=e.updateAll[h],l={},p=Container.resolveType(i.type).memberDefinitions.getKeyProperties(),n=0;n<p.length;n++){var k=p[n];l[k.computed?"_id":k.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(k.type))](i.entity[k.name])}for(var r={},p=Container.resolveType(i.entity.getType()).memberDefinitions.getPublicMappedProperties().concat(Container.resolveType(i.physicalData.getType()).memberDefinitions.getPublicMappedProperties()),
n=0;n<p.length;n++){var m=p[n];if(0<=i.entity.changedProperties.indexOf(m)||i.physicalData.changedProperties&&0<=i.physicalData.changedProperties.indexOf(m))if(m.concurrencyMode===$data.ConcurrencyMode.Fixed)l[m.name]=c._typeFactory(m.type,i.data[m.name],c.fieldConverter.toDb),r.$inc||(r.$inc={}),r.$inc[m.name]=1;else if(!m.computed&&"undefined"!==typeof i.data[m.name])if(Container.resolveType(m.type)===$data.Array&&m.elementType&&Container.resolveType(m.elementType)===$data.ObjectID){r[m.name]=c._typeFactory(m.type,
i.physicalData[m.name],c.fieldConverter.toDb);var s=r[m.name];if(s)for(k=0;k<s.length;k++)s[k]=c._typeFactory(m.elementType,s[k],c.fieldConverter.toDb)}else r[m.name]=c._typeFactory(m.type,i.physicalData[m.name],c.fieldConverter.toDb)}(function(e){j.update(l,{$set:r},{safe:!0},function(h,i){if(h)b.error(h),a.close();else if(i){d++;for(var k=Container.resolveType(e.type).memberDefinitions.getPublicMappedProperties(),m=0;m<k.length;m++){var n=k[m];n.concurrencyMode===$data.ConcurrencyMode.Fixed&&e.entity[n.name]++}g(function(){o(a,
d)})}else f--,j.find({_id:l._id},{}).toArray(function(f,h){if(f)b.error(f);else{for(var j=h[0],i=Container.resolveType(e.type).memberDefinitions.getPublicMappedProperties(),k=0;k<i.length;k++){var l=i[k];e.entity[l.name]=c._typeFactory(l.type,j[l.computed?"_id":l.name],c.fieldConverter.fromDb)}g(function(){o(a,d)})}})})})(i)}},l=function(a,e,h){f=e.removeAll.length;for(var j=0;j<e.removeAll.length;j++){var l=e.removeAll[j],q;for(q in l.data)(void 0===l.data[q]||null===l.data[q])&&delete l.data[q];
var p=Container.resolveType(l.type).memberDefinitions.getKeyProperties();for(q=0;q<p.length;q++){var n=p[q];l.data[n.computed?"_id":n.name]=c.fieldConverter.toDb[Container.resolveName(Container.resolveType(n.type))](l.entity[n.name])}p=Container.resolveType(l.type).memberDefinitions.getPublicMappedProperties();for(q=0;q<p.length;q++)n=p[q],n.key||delete l.data[n.name];h.remove(l.data,{safe:!0},function(c,j){c?(b.error(c),a.close()):(j?d++:f--,g(function(){e.updateAll&&e.updateAll.length?i(a,e,h):
o(a,d)}))})}},h=Object.keys(a),o=function(d,e){if(h.length){var f=h.pop();if(a.hasOwnProperty(f)){var g=a[f],f=new c.driver.Collection(d,f);g.insertAll&&g.insertAll.length?j(d,g,f):g.removeAll&&g.removeAll.length?l(d,g,f):g.updateAll&&g.updateAll.length?i(d,g,f):(b.success(0),d.close())}}else b.success(e),d.close()};(new this.driver.Db(this.providerConfiguration.databaseName,e,{safe:!1})).open(function(a,d){a?b.error(a):c.providerConfiguration.username?d.authenticate(c.providerConfiguration.username,
c.providerConfiguration.password,function(a,c){a?b.error(a):c&&o(d)}):o(d)})},saveChanges:function(b,a){var c=this;if(a.length){var d=this.buildIndependentBlocks(a),e=[],f=0,g=function(a){for(var i={},l=0;l<a.length;l++){e.push(a[l].data);var h=i[a[l].entitySet.name];h||(h={},i[a[l].entitySet.name]=h);var o={entity:a[l].data,data:c.save_getInitData(a[l],e),physicalData:a[l].physicalData,type:Container.resolveName(a[l].data.getType())};switch(a[l].data.entityState){case $data.EntityState.Unchanged:continue;
case $data.EntityState.Added:h.insertAll||(h.insertAll=[]);h.insertAll.push(o);break;case $data.EntityState.Modified:h.updateAll||(h.updateAll=[]);h.updateAll.push(o);break;case $data.EntityState.Deleted:h.removeAll||(h.removeAll=[]);h.removeAll.push(o);break;default:Guard.raise(new Exception("Not supported Entity state"))}}c._saveCollections({success:function(a){f+=a;d.length?g(d.shift()):b.success(f)},error:b.error},i)};d.length&&g(d.shift())}else b.success(0)},buildDbType_generateConvertToFunction:function(b){var a=
this;return function(c){var d=new b.PhysicalType;d.entityState=c.entityState;b.PhysicalType.memberDefinitions.getPublicMappedProperties().forEach(function(a){d.initData[a.name]=c[a.name]},this);b.Associations&&b.Associations.forEach(function(b){if("*"==b.FromMultiplicity&&"0..1"==b.ToMultiplicity||"0..1"==b.FromMultiplicity&&"1"==b.ToMultiplicity){var f=c[b.FromPropertyName];void 0!==f&&b.ReferentialConstraint.forEach(function(c){null!==f?(d.initData[b.FromPropertyName]={$ref:a._entitySetReferences[b.To].tableName,
$id:a.storageProvider._typeFactory(f.getType().memberDefinitions.getMember(c[b.To]).type,f[c[b.To]],a.storageProvider.fieldConverter.toDb)},d.initData[c[b.From]]=a.storageProvider._typeFactory(f.getType().memberDefinitions.getMember(c[b.To]).type,f[c[b.To]],a.storageProvider.fieldConverter.toDb)):(d.initData[b.FromPropertyName]=null,d.initData[c[b.From]]=null);d._setPropertyChanged(d.getType().memberDefinitions.getMember(c[b.From]))},this)}},this);b.ComplexTypes&&b.ComplexTypes.forEach(function(b){d.initData[b.FromPropertyName]=
a.storageProvider._typeFactory(b.ToType,c[b.FromPropertyName],a.storageProvider.fieldConverter.toDb)},this);return d}},buildDbType_modifyInstanceDefinition:function(b,a){var c=function(a,b,c,g){var j={};j[a.name]=c;j[b.name]=g+"__"+c;return j};a.Associations&&a.Associations.forEach(function(a){var e=!1,f=a.FromType,g=a.ToType,j=a.ToPropertyName;a.ReferentialConstraint=a.ReferentialConstraint||[];if("*"==a.FromMultiplicity&&"0..1"==a.ToMultiplicity||"0..1"==a.FromMultiplicity&&"1"==a.ToMultiplicity)f=
a.ToType,g=a.FromType,j=a.FromPropertyName,e=!0;f.memberDefinitions.getPublicMappedProperties().filter(function(a){return a.key}).forEach(function(i){if(e){var l=j+"__"+i.name,h;j?(h=JSON.parse(JSON.stringify(b[j])),h.kind=i.kind,h.name=i.name,h.notMapped=!1):h=JSON.parse(JSON.stringify(i));h.dataType=Container.resolveType(i.dataType);h.type=h.dataType;h.key=!1;h.computed=!1;b[l]=h}a.ReferentialConstraint.push(c(f,g,i.name,j))},this)},this)},save_getInitData:function(b,a){b.physicalData=this.context._storageModel.getStorageModel(b.data.getType()).PhysicalType.convertTo(b.data,
a);var c={};b.physicalData.getType().memberDefinitions.asArray().forEach(function(a){if(a.kind==$data.MemberTypes.navProperty||a.kind==$data.MemberTypes.complexProperty||a.kind==$data.MemberTypes.property&&!a.notMapped)c[a.computed?"_id":a.name]=b.physicalData[a.name]},this);return c},supportedDataTypes:{value:[$data.Integer,$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date,$data.ObjectID,$data.Object,$data.GeographyPoint,$data.Guid,$data.GeographyLineString,$data.GeographyPolygon,$data.GeographyMultiPoint,
$data.GeographyMultiLineString,$data.GeographyMultiPolygon,$data.GeographyCollection,$data.GeometryPoint,$data.GeometryLineString,$data.GeometryPolygon,$data.GeometryMultiPoint,$data.GeometryMultiLineString,$data.GeometryMultiPolygon,$data.GeometryCollection,$data.Byte,$data.SByte,$data.Decimal,$data.Float,$data.Int16,$data.Int32,$data.Int64,$data.Time,$data.DateTimeOffset],writable:!1},supportedBinaryOperators:{value:{equal:{mapTo:":",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},
notEqual:{mapTo:"$ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},equalTyped:{mapTo:":",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},notEqualTyped:{mapTo:"$ne",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},greaterThan:{mapTo:"$gt",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},greaterThanOrEqual:{mapTo:"$gte",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},lessThan:{mapTo:"$lt",dataType:"boolean",
allowedIn:[$data.Expressions.FilterExpression]},lessThenOrEqual:{mapTo:"$lte",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},or:{mapTo:"$or",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},and:{mapTo:"$and",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression]},"in":{mapTo:"$in",allowedIn:[$data.Expressions.FilterExpression]}}},supportedUnaryOperators:{value:{not:{mapTo:"$nor"}}},supportedFieldOperations:{value:{contains:{dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression],
parameters:[{name:"substring",dataType:"string"}]},startsWith:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},endsWith:{dataType:"string",allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]}},enumerable:!0,writable:!0},supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},batchDelete:{},
single:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{},include:{},withInlineCount:{},some:{invokable:!1,allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"filter",dataType:"$data.Queryable"}],mapTo:"some",frameType:$data.Expressions.SomeExpression},every:{invokable:!1,allowedIn:[$data.Expressions.FilterExpression],parameters:[{name:"filter",dataType:"$data.Queryable"}],mapTo:"every",frameType:$data.Expressions.EveryExpression}},enumerable:!0,writable:!0},fieldConverter:{value:$data.mongoDBConverter}},
{isSupported:{get:function(){return!$data.mongoDBDriver?!1:!0},set:function(){}}});$data.storageProviders.mongoDB.mongoDBProvider.isSupported&&$data.StorageProviderBase.registerProvider("mongoDB",$data.storageProviders.mongoDB.mongoDBProvider);try{"undefined"===typeof navigator&&(navigator=window.navigator=require("navigator"))}catch(err$$1){}
$data.Class.define("$data.storageProviders.mongoDB.mongoDBProvider.ClientObjectID",null,null,{constructor:function(){var b=Math.floor((new Date).getTime()/1E3).toString(16),a=btoa(navigator?navigator.userAgent:"nodejs"),c=(a.charCodeAt(0)+a.charCodeAt(1)).toString(16)+(a.charCodeAt(2)+a.charCodeAt(3)).toString(16)+(a.charCodeAt(4)+a.charCodeAt(5)).toString(16),d=("0000"+Math.floor(65535*Math.random()).toString(16)).slice(-4),e=("000000"+(++$data.storageProviders.mongoDB.mongoDBProvider.ClientObjectID.idSeed).toString(16)).slice(-6);
this.toString=this.toLocaleString=this.valueOf=function(){return btoa(b+c+d+e)}},value:{value:null}},{idSeed:{value:Math.floor(255*Math.random())}});
