// JayData 1.3.4
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
$data.FacebookConverter={fromDb:{"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.String":$data.Container.proxyConverter,"$data.Date":function(b){return new Date("string"===typeof b?
parseInt(b):b)},"$data.Boolean":function(b){return!!b},"$data.Blob":$data.Container.proxyConverter,"$data.Array":function(b){return void 0===b?new $data.Array:b}},toDb:{"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,
"$data.String":function(b){return"'"+b+"'"},"$data.Date":function(b){return b?b.valueOf():null},"$data.Boolean":$data.Container.proxyConverter,"$data.Blob":$data.Container.proxyConverter,"$data.Array":function(b){return"("+b.join(", ")+")"}}};
$data.Class.define("$data.storageProviders.Facebook.FacebookProvider",$data.StorageProviderBase,null,{constructor:function(b){this.SqlCommands=[];this.context={};this.providerConfiguration=$data.typeSystem.extend({FQLFormat:"format=json",FQLQueryUrl:"https://graph.facebook.com/fql?q=",Access_Token:""},b);this.initializeStore=function(a){a=$data.typeSystem.createCallbackSetting(a);a.success(this.context)}},AuthenticationProvider:{dataType:"$data.Authentication.AuthenticationBase",enumerable:!1},supportedDataTypes:{value:[$data.Integer,
$data.Number,$data.Date,$data.String,$data.Boolean,$data.Blob,$data.Array],writable:!1},supportedFieldOperations:{value:{contains:{dataType:$data.String,allowedIn:$data.Expressions.FilterExpression,mapTo:"strpos",parameters:[{name:"@expression",dataType:$data.String},{name:"strFragment",dataType:$data.String}],rigthValue:") >= 0"},startsWith:{dataType:$data.String,allowedIn:$data.Expressions.FilterExpression,mapTo:"strpos",parameters:[{name:"@expression",dataType:$data.String},{name:"strFragment",
dataType:$data.String}],rigthValue:") = 0"},strpos:{dataType:$data.Integer,allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"strpos",parameters:[{name:"@expression",dataType:$data.String},{name:"strFragment",dataType:$data.String}]},substr:{dataType:$data.String,allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"substr",parameters:[{name:"@expression",dataType:$data.String},{name:"startIdx",dataType:$data.Number},
{name:"length",dataType:$data.Number}]},strlen:{dataType:$data.Integer,allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.ProjectionExpression],mapTo:"strlen",parameters:[{name:"@expression",dataType:$data.String}]}},enumerable:!0,writable:!0},supportedBinaryOperators:{value:{equal:{mapTo:" = ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},notEqual:{mapTo:" != ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},equalTyped:{mapTo:" = ",dataType:$data.Boolean,
allowedIn:$data.Expressions.FilterExpression},notEqualTyped:{mapTo:" != ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},greaterThan:{mapTo:" > ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},greaterThanOrEqual:{mapTo:" >= ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},lessThan:{mapTo:" < ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},lessThenOrEqual:{mapTo:" <= ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},
or:{mapTo:" OR ",dataType:$data.Boolean,allowedIn:$data.Expressions.FilterExpression},and:{mapTo:" AND ",dataType:$data.Booleanv},"in":{mapTo:" IN ",dataType:$data.Boolean,resolvableType:[$data.Array,$data.Queryable],allowedIn:$data.Expressions.FilterExpression}}},supportedUnaryOperators:{value:{}},fieldConverter:{value:$data.FacebookConverter},supportedSetOperations:{value:{filter:{},length:{},map:{},forEach:{},toArray:{},single:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{}},enumerable:!0,
writable:!0},executeQuery:function(b,a){a=$data.typeSystem.createCallbackSetting(a);this.AuthenticationProvider||(this.AuthenticationProvider=new $data.Authentication.Anonymous({}));var c;try{c=this._compile(b)}catch(e){a.error(e);return}var d=b.defaultType,f=[];c.selectMapping||this._discoverType("",d,f);c=this.providerConfiguration.FQLQueryUrl+encodeURIComponent(c.queryText)+"&"+this.providerConfiguration.FQLFormat;this.providerConfiguration.Access_Token&&(c+="&access_token="+this.providerConfiguration.Access_Token);
c={url:c,dataType:"JSON",success:function(c){b.rawDataList=c.data;Container.createModelBinderConfigCompiler(b,[]).Visit(b.expression);if(b.expression instanceof $data.Expressions.CountExpression)b.rawDataList=[{cnt:c.data.length}];a.success(b)},error:function(b,c,e){c={};try{c=JSON.parse(b.responseText).error}catch(f){c=e+": "+b.responseText}a.error(c)}};this.context.prepareRequest.call(this,c);this.AuthenticationProvider.CreateRequest(c)},_discoverType:function(b,a,c){a.memberDefinitions.getPublicMappedProperties().forEach(function(a){var d=
Container.resolveType(a.dataType);if(d.isAssignableTo||d==Array){var f=b?b+"."+a.name:a.name;if(d==Array||d.isAssignableTo($data.EntitySet))if(a.inverseProperty)d=Container.resolveType(a.elementType);else return;c.push({name:f,type:d});this._discoverType(f,d,c)}},this)},_compile:function(b){return Container.createFacebookCompiler().compile(b)},getTraceString:function(b){this.AuthenticationProvider||(this.AuthenticationProvider=new $data.Authentication.Anonymous({}));return this._compile(b)},setContext:function(b){this.context=
b},saveChanges:function(){Guard.raise(new Exception("Not implemented","Not implemented"))}},null);$data.StorageProviderBase.registerProvider("Facebook",$data.storageProviders.Facebook.FacebookProvider);
$C("$data.storageProviders.Facebook.FacebookCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(){this.provider={}},compile:function(b){this.provider=b.context.storageProvider;var a={filterSql:{sql:""},projectionSql:{sql:""},orderSql:{sql:""},skipSql:{sql:""},takeSql:{sql:""},tableName:""};this.Visit(b.expression,a);var c=!1;a.projectionSql.sql||(a.projectionSql=this.autoGenerateProjection(b),c=!0);""==a.filterSql.sql&&Guard.raise(new Exception("Filter/where statement is required",
"invalid operation"));return{queryText:a.projectionSql.sql+" FROM "+a.tableName+a.filterSql.sql+a.orderSql.sql+a.takeSql.sql+(a.takeSql.sql?a.skipSql.sql:""),selectMapping:!1==c?a.projectionSql.selectFields:null,params:[]}},autoGenerateProjection:function(b){var a=b.context.getEntitySetFromElementType(b.defaultType),a=new $data.Queryable(b.context,a.expression),c=Container.createCodeExpression(this.generateProjectionFunc(b)),c=Container.createProjectionExpression(a.expression,c),a=Container.createQueryable(a,
c).expression,a=Container.createQueryExpressionCreator(b.context).Visit(a),b={projectionSql:{sql:""}};this.Visit(a,b);return b.projectionSql},generateProjectionFunc:function(b){var a=this.provider.AuthenticationProvider.Authenticated||this.provider.providerConfiguration.Access_Token,b=b.defaultType.memberDefinitions.getPublicMappedProperties();!a&&b.some(function(a){return!0==a.isPublic})&&(b=b.filter(function(a){return!0==a.isPublic}));var c="function (s){ return {";b.forEach(function(a,b){0!=b&&
(c+=", ");c+=a.name+": s."+a.name});return c+="}; }"},VisitFilterExpression:function(b,a){this.Visit(b.source,a);a.filterSql.type=b.nodeType;a.filterSql.sql=""==a.filterSql.sql?" WHERE ":a.filterSql.sql+" AND ";this.Visit(b.selector,a.filterSql)},VisitProjectionExpression:function(b,a){this.Visit(b.source,a);a.projectionSql.type=b.nodeType;""==a.projectionSql.sql?a.projectionSql.sql="SELECT ":Guard.raise(new Exception("Multiple select error"));this.Visit(b.selector,a.projectionSql)},VisitOrderExpression:function(b,
a){this.Visit(b.source,a);a.orderSql.type=b.nodeType;""==a.orderSql.sql?a.orderSql.sql=" ORDER BY ":Guard.raise(new Exception("Multiple sorting not supported","not supported"));this.Visit(b.selector,a.orderSql);a.orderSql.sql+=b.nodeType==$data.Expressions.ExpressionType.OrderByDescending?" DESC":" ASC"},VisitPagingExpression:function(b,a){this.Visit(b.source,a);b.nodeType==$data.Expressions.ExpressionType.Skip?(a.skipSql.type=b.nodeType,a.skipSql.sql=" OFFSET ",this.Visit(b.amount,a.skipSql)):b.nodeType==
$data.Expressions.ExpressionType.Take&&(a.takeSql.type=b.nodeType,a.takeSql.sql=" LIMIT ",this.Visit(b.amount,a.takeSql))},VisitSimpleBinaryExpression:function(b,a){a.sql+="(";this.Visit(b.left,a);a.sql+=b.resolution.mapTo;b.resolution.resolvableType&&!Guard.requireType(b.resolution.mapTo+" expression.right.value",b.right.value,b.resolution.resolvableType)&&Guard.raise(new Exception(b.right.type+" not allowed in '"+b.resolution.mapTo+"' statement","invalid operation"));if("in"===b.resolution.name&&
b.right.value instanceof Array){var c=this;a.sql+="(";b.right.value.forEach(function(b,d){0<d&&(a.sql+=", ");c.Visit(b,a)});a.sql+=")"}else this.Visit(b.right,a);a.sql+=")"},VisitEntityFieldExpression:function(b,a){this.Visit(b.selector,a)},VisitMemberInfoExpression:function(b,a){var c=b.memberName;a.sql+=c;a.fieldData={name:c,dataType:b.memberDefinition.dataType};"Projection"==a.type&&!a.selectFields&&(a.selectFields=!0===a.fieldOperation?[{from:"anon"}]:[{from:c,dataType:b.memberDefinition.dataType}])},
VisitConstantExpression:function(b,a){"Projection"==a.type&&Guard.raise(new Exception("Constant value is not supported in Projection.","Not supported!"));this.VisitQueryParameterExpression(b,a)},VisitQueryParameterExpression:function(b,a){if(b.value instanceof $data.storageProviders.Facebook.EntitySets.Command)a.sql+=""+b.value+"";else if(b.value instanceof $data.Queryable)a.sql+="("+b.value.toTraceString().queryText+")";else{var c=Container.resolveType(b.type);a.sql=-1!=this.provider.supportedDataTypes.indexOf(c)?
a.sql+this.provider.fieldConverter.toDb[Container.resolveName(c)](b.value):a.sql+(""+b.value+"")}},VisitParametricQueryExpression:function(b,a){this.Visit(b.expression,a);a.parameters=b.parameters},VisitEntitySetExpression:function(b,a){a.tableName=b.instance.tableName},VisitObjectLiteralExpression:function(b,a){var c=this;a.selectFields=a.selectFields||[];b.members.forEach(function(b){b.expression instanceof $data.Expressions.ObjectLiteralExpression?(a.mappingPrefix=a.mappingPrefix||[],a.mappingPrefix.push(b.fieldName),
c.Visit(b,a),a.mappingPrefix.pop()):(0<a.selectFields.length&&(a.sql+=", "),c.Visit(b,a),b=a.mappingPrefix instanceof Array?a.mappingPrefix.join(".")+"."+b.fieldName:b.fieldName,a.selectFields.push({from:a.fieldData.name,to:b,dataType:a.fieldData.dataType}))})},VisitObjectFieldExpression:function(b,a){return this.Visit(b.expression,a)},VisitEntityFieldOperationExpression:function(b,a){Guard.requireType("expression.operation",b.operation,$data.Expressions.MemberInfoExpression);var c=b.operation.memberDefinition,
e=c.mapTo||c.name;a.sql+="(";!1==c.expressionInParameter&&this.Visit(b.source,a);a.sql+=e;a.sql+="(";var d=0;(c.parameters||[]).map(function(a){var c={dataType:a.dataType};a.value?c.value=a.value:"@expression"===a.name?c.value=b.source:(c.value=b.parameters[d],c.itemType=b.parameters[d++].type);return c}).forEach(function(c,d){var e=c.itemType?Container.resolveType(c.itemType):null;if(!e||c.dataType instanceof Array&&-1!=c.dataType.indexOf(e)||c.dataType==e){if(0<d&&(a.sql+=", "),"Projection"==a.type&&
(a.fieldOperation=!0),this.Visit(c.value,a),"Projection"==a.type)a.fieldOperation=void 0}else Guard.raise(new Exception(c.dataType+" not allowed in '"+b.operation.memberName+"' statement","invalid operation"))},this);a.fieldData&&a.fieldData.name&&(a.fieldData.name="anon");a.sql=c.rigthValue?a.sql+c.rigthValue:a.sql+")";a.sql+=")"}},null);
$data.Class.define("$data.Facebook.types.FbUser",$data.Entity,null,{uid:{type:"number",key:!0,isPublic:!0,searchable:!0},username:{type:"string",isPublic:!0,searchable:!0},first_name:{type:"string",isPublic:!0},middle_name:{type:"string",isPublic:!0},last_name:{type:"string",isPublic:!0},name:{type:"string",isPublic:!0,searchable:!0},pic_small:{type:"string"},pic_big:{type:"string"},pic_square:{type:"string"},pic:{type:"string"},affiliations:{type:"Array",elementType:"Object"},profile_update_time:{type:"datetime"},
timezone:{type:"number"},religion:{type:"string"},birthday:{type:"string"},birthday_date:{type:"string"},sex:{type:"string",isPublic:!0},hometown_location:{type:"Array",elementType:"Object"},meeting_sex:{type:"Array",elementType:"Object"},meeting_for:{type:"Array",elementType:"Object"},relationship_status:{type:"string"},significant_other_id:{type:"number"},political:{type:"string"},current_location:{type:"Array",elementType:"Object"},activities:{type:"string"},interests:{type:"string"},is_app_user:{type:"bool"},
music:{type:"string"},tv:{type:"string"},movies:{type:"string"},books:{type:"string"},quotes:{type:"string"},about_me:{type:"string"},hs_info:{type:"Array",elementType:"Object"},education_history:{type:"Array",elementType:"Object"},work_history:{type:"Array",elementType:"Object"},notes_count:{type:"number"},wall_count:{type:"number"},status:{type:"string"},has_added_app:{type:"bool"},online_presence:{type:"string"},locale:{type:"string",isPublic:!0},proxied_email:{type:"string"},profile_url:{type:"string"},
email_hashes:{type:"Array",elementType:"Object"},pic_small_with_logo:{type:"string",isPublic:!0},pic_big_with_logo:{type:"string",isPublic:!0},pic_square_with_logo:{type:"string",isPublic:!0},pic_with_logo:{type:"string",isPublic:!0},allowed_restrictions:{type:"string"},verified:{type:"bool"},profile_blurb:{type:"string"},family:{type:"Array",elementType:"Object"},website:{type:"string"},is_blocked:{type:"bool"},contact_email:{type:"string"},email:{type:"string"},third_party_id:{type:"string",searchable:!0},
name_format:{type:"string"},video_upload_limits:{type:"Array",elementType:"Object"},games:{type:"string"},work:{type:"Array",elementType:"Object"},education:{type:"Array",elementType:"Object"},sports:{type:"Array",elementType:"Object"},favorite_athletes:{type:"Array",elementType:"Object"},favorite_teams:{type:"Array",elementType:"Object"},inspirational_people:{type:"Array",elementType:"Object"},languages:{type:"Array",elementType:"Object"},likes_count:{type:"number"},friend_count:{type:"number"},
mutual_friend_count:{type:"number"},can_post:{type:"bool"}},null);$data.Class.define("$data.Facebook.types.FbFriend",$data.Entity,null,{uid1:{type:"number",key:!0,searchable:!0},uid2:{type:"number",key:!0,searchable:!0}},null);
$data.Class.define("$data.Facebook.types.FbPage",$data.Entity,null,{page_id:{type:"number",key:!0,isPublic:!0,searchable:!0},name:{type:"string",isPublic:!0,searchable:!0},username:{type:"string",isPublic:!0,searchable:!0},description:{type:"string",isPublic:!0},categories:{type:"array",isPublic:!0},is_community_page:{type:"bool",isPublic:!0},pic_small:{type:"string",isPublic:!0},pic_big:{type:"string",isPublic:!0},pic_square:{type:"string",isPublic:!0},pic:{type:"string",isPublic:!0},pic_large:{type:"string",
isPublic:!0},pic_cover:{type:"object",isPublic:!0},unread_notif_count:{type:"number",isPublic:!1},new_like_count:{type:"number",isPublic:!1},fan_count:{type:"number",isPublic:!0},type:{type:"string",isPublic:!0},website:{type:"string",isPublic:!0},has_added_app:{type:"bool",isPublic:!0},general_info:{type:"string",isPublic:!0},can_post:{type:"bool",isPublic:!0},checkins:{type:"number",isPublic:!0},is_published:{type:"bool",isPublic:!0},founded:{type:"string",isPublic:!0},company_overview:{type:"string",
isPublic:!0},mission:{type:"string",isPublic:!0},products:{type:"string",isPublic:!0},location:{type:"object",isPublic:!0},parking:{type:"object",isPublic:!0},hours:{type:"array",isPublic:!0},pharma_safety_info:{type:"string",isPublic:!0},public_transit:{type:"string",isPublic:!0},attire:{type:"string",isPublic:!0},payment_options:{type:"object",isPublic:!0},culinary_team:{type:"string",isPublic:!0},general_manager:{type:"string",isPublic:!0},price_range:{type:"string",isPublic:!0},restaurant_services:{type:"object",
isPublic:!0},restaurant_specialties:{type:"object",isPublic:!0},phone:{type:"string",isPublic:!0},release_date:{type:"string",isPublic:!0},genre:{type:"string",isPublic:!0},starring:{type:"string",isPublic:!0},screenplay_by:{type:"string",isPublic:!0},directed_by:{type:"string",isPublic:!0},produced_by:{type:"string",isPublic:!0},studio:{type:"string",isPublic:!0},awards:{type:"string",isPublic:!0},plot_outline:{type:"string",isPublic:!0},season:{type:"string",isPublic:!0},network:{type:"string",
isPublic:!0},schedule:{type:"string",isPublic:!0},written_by:{type:"string",isPublic:!0},band_members:{type:"string",isPublic:!0},hometown:{type:"string",isPublic:!0},current_location:{type:"string",isPublic:!0},record_label:{type:"string",isPublic:!0},booking_agent:{type:"string",isPublic:!0},press_contact:{type:"string",isPublic:!0},artists_we_like:{type:"string",isPublic:!0},influences:{type:"string",isPublic:!0},band_interests:{type:"string",isPublic:!0},bio:{type:"string",isPublic:!0},affiliation:{type:"string",
isPublic:!0},birthday:{type:"string",isPublic:!0},personal_info:{type:"string",isPublic:!0},personal_interests:{type:"string",isPublic:!0},built:{type:"string",isPublic:!0},features:{type:"string",isPublic:!0},mpg:{type:"string",isPublic:!0}},null);
$data.Class.define("$data.storageProviders.Facebook.EntitySets.Command",null,null,{constructor:function(b){this.Config=$data.typeSystem.extend({CommandValue:""},b)},toString:function(){return this.Config.CommandValue},Config:{}},{"to$data.Integer":function(b){return b},"to$data.Number":function(b){return b}});
$data.Class.define("$data.Facebook.FQLContext",$data.EntityContext,null,{constructor:function(){this.MyFriends=this.Users.where(function(b){return b.uid in this.friends},{friends:this.Friends.where(function(b){return b.uid1==this.me},{me:$data.Facebook.FQLCommands.me}).select(function(b){return b.uid2})})},Users:{dataType:$data.EntitySet,tableName:"user",elementType:$data.Facebook.types.FbUser},Friends:{dataType:$data.EntitySet,tableName:"friend",elementType:$data.Facebook.types.FbFriend},Pages:{dataType:$data.EntitySet,
tableName:"page",elementType:$data.Facebook.types.FbPage}},null);$data.Facebook.FQLCommands={__namespace:!0,me:new $data.storageProviders.Facebook.EntitySets.Command({CommandValue:"me()"}),now:new $data.storageProviders.Facebook.EntitySets.Command({CommandValue:"now()"})};
