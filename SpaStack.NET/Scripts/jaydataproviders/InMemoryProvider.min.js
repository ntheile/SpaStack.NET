// JayData 1.3.4
// Dual licensed under MIT and GPL v2
// Copyright JayStack Technologies (http://jaydata.org/licensing)
//
// JayData is a standards-based, cross-platform Javascript library and a set of
// practices to access and manipulate data from various online and offline sources.
//
// Credits:
//     Hajnalka Battancs, Dániel József, János Roden, László Horváth, Péter Nochta
//     Péter Zentai, Róbert Bónay, Szabolcs Czinege, Viktor Borza, Viktor Lázár,
//     Zoltán Gyebrovszki, Gábor Dolla
//
// More info: http://jaydata.org
$data.InMemoryConverter={fromDb:{"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Date":$data.Container.proxyConverter,"$data.DateTimeOffset":$data.Container.proxyConverter,
"$data.Time":$data.Container.proxyConverter,"$data.String":$data.Container.proxyConverter,"$data.Boolean":$data.Container.proxyConverter,"$data.Blob":$data.Container.proxyConverter,"$data.Object":function(a){return void 0===a?new $data.Object:a},"$data.Array":function(a){return void 0===a?new $data.Array:a},"$data.Guid":function(a){return a?$data.parseGuid(a).toString():a},"$data.GeographyPoint":function(a){return a?new $data.GeographyPoint(a):a},"$data.GeographyLineString":function(a){return a?new $data.GeographyLineString(a):
a},"$data.GeographyPolygon":function(a){return a?new $data.GeographyPolygon(a):a},"$data.GeographyMultiPoint":function(a){return a?new $data.GeographyMultiPoint(a):a},"$data.GeographyMultiLineString":function(a){return a?new $data.GeographyMultiLineString(a):a},"$data.GeographyMultiPolygon":function(a){return a?new $data.GeographyMultiPolygon(a):a},"$data.GeographyCollection":function(a){return a?new $data.GeographyCollection(a):a},"$data.GeometryPoint":function(a){return a?new $data.GeometryPoint(a):
a},"$data.GeometryLineString":function(a){return a?new $data.GeometryLineString(a):a},"$data.GeometryPolygon":function(a){return a?new $data.GeometryPolygon(a):a},"$data.GeometryMultiPoint":function(a){return a?new $data.GeometryMultiPoint(a):a},"$data.GeometryMultiLineString":function(a){return a?new $data.GeometryMultiLineString(a):a},"$data.GeometryMultiPolygon":function(a){return a?new $data.GeometryMultiPolygon(a):a},"$data.GeometryCollection":function(a){return a?new $data.GeometryCollection(a):
a}},toDb:{"$data.Byte":$data.Container.proxyConverter,"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Date":$data.Container.proxyConverter,"$data.DateTimeOffset":$data.Container.proxyConverter,
"$data.Time":$data.Container.proxyConverter,"$data.String":$data.Container.proxyConverter,"$data.Boolean":$data.Container.proxyConverter,"$data.Blob":$data.Container.proxyConverter,"$data.Object":$data.Container.proxyConverter,"$data.Array":$data.Container.proxyConverter,"$data.Guid":function(a){return a?a.toString():a},"$data.GeographyPoint":function(a){return a},"$data.GeographyLineString":function(a){return a},"$data.GeographyPolygon":function(a){return a},"$data.GeographyMultiPoint":function(a){return a},
"$data.GeographyMultiLineString":function(a){return a},"$data.GeographyMultiPolygon":function(a){return a},"$data.GeographyCollection":function(a){return a},"$data.GeometryPoint":function(a){return a},"$data.GeometryLineString":function(a){return a},"$data.GeometryPolygon":function(a){return a},"$data.GeometryMultiPoint":function(a){return a},"$data.GeometryMultiLineString":function(a){return a},"$data.GeometryMultiPolygon":function(a){return a},"$data.GeometryCollection":function(a){return a}},escape:{"$data.Byte":$data.Container.proxyConverter,
"$data.SByte":$data.Container.proxyConverter,"$data.Decimal":$data.Container.proxyConverter,"$data.Float":$data.Container.proxyConverter,"$data.Int16":$data.Container.proxyConverter,"$data.Int64":$data.Container.proxyConverter,"$data.Integer":$data.Container.proxyConverter,"$data.Int32":$data.Container.proxyConverter,"$data.Number":$data.Container.proxyConverter,"$data.Date":function(a){return a?"new Date(Date.parse('"+a.toISOString()+"'))":a},"$data.DateTimeOffset":function(a){return a?"new Date(Date.parse('"+
a.toISOString()+"'))":a},"$data.Time":function(a){return a?"'"+a+"'":a},"$data.String":function(a){return"'"+a.replace(/'/g,"''")+"'"},"$data.Boolean":function(a){return a?"true":"false"},"$data.Blob":function(a){return"'"+$data.Blob.toString(a)+"'"},"$data.Object":function(a){return JSON.stringify(a)},"$data.Array":function(a){return JSON.stringify(a)},"$data.Guid":function(a){return a?"'"+a.toString()+"'":a}}};
$C("$data.storageProviders.InMemory.InMemoryProvider",$data.StorageProviderBase,null,{constructor:function(a,b){this.context=b;this.providerConfiguration=$data.typeSystem.extend({source:null,persistentData:!1,localStoreName:"JayData_InMemory_Provider",databaseName:"JayData_InMemory_Provider",__instaceId:$data.createGuid().toString()},a);this.dataSource=this.providerConfiguration.source;delete this.providerConfiguration.source;"JayData_InMemory_Provider"===this.providerConfiguration.databaseName&&
(this.providerConfiguration.databaseName=this.providerConfiguration.localStoreName)},initializeStore:function(a){var a=$data.typeSystem.createCallbackSetting(a),b=[],c;for(c in this.context._entitySetReferences)b.push(this.context._entitySetReferences[c].collectionName);var e=null;if(this.providerConfiguration.persistentData&&window.localStorage&&this.providerConfiguration.dbCreation!==$data.storageProviders.DbCreationType.DropAllExistingTables){var d=this,g=window.localStorage.getItem(this.providerConfiguration.databaseName||
"JayData_InMemory_Provider");Object.isNullOrUndefined(g)||(e=JSON.parse(g,function(a,c){return-1<b.indexOf(a)&&c.map?c.map(function(b){return new d.context[a].createNew(b)}):c}))}g=e||this.dataSource||{};this.dataSource={inmemory_sequence:{}};for(var i=0;i<this.context._storageModel.length;i++){var f=this.context._storageModel[i];this.dataSource[f.TableName]=[];var j=f.LogicalType.memberDefinitions.getKeyProperties().filter(function(a){return a.computed});1<j.length&&Guard.raise(new Exception("More than one computed field not supported in "+
f.TableName+" entity set."));var k=!1;1===j.length&&(c=Container.resolveName(j[0].type),!0===this.supportedAutoincrementKeys[c]?(this.dataSource.inmemory_sequence[f.TableName]=0,k=!0):"function"!==typeof this.supportedAutoincrementKeys[c]&&console.log("WARRNING! '"+c+"' not supported as computed Key!"));if(g[f.TableName])for(c=0;c<g[f.TableName].length;c++){var h=g[f.TableName][c];h instanceof f.LogicalType||(e?h=new f.LogicalType(h):Guard.raise(new Exception("Invalid element in source: "+f.TableName)));
if(k){var l=h[j[0].name];l>this.dataSource.inmemory_sequence[f.TableName]&&(this.dataSource.inmemory_sequence[f.TableName]=l)}this.dataSource[f.TableName].push(h)}}a.success(this.context)},executeQuery:function(a,b){var b=$data.typeSystem.createCallbackSetting(b),c;try{c=this._compile(a)}catch(e){b.error(e);return}var d=[].concat(this.dataSource[a.context.getEntitySetFromElementType(a.defaultType).tableName]||[]);c.$filter&&!c.$every&&(d=d.filter(c.$filter));c.$map&&0===Object.keys(a.modelBinderConfig).length&&
(d=d.map(c.$map));c.$order&&0<c.$order.length&&d.sort(function(a,b){for(var d,e=0,k=c.$order.length;e<k;e++){d=c.$order[e](a);var h=c.$order[e](b);d=c.$order[e].ASC?d===h?0:d>h||null===h?1:-1:d===h?0:d<h||null===d?1:-1;if(0!==d)break}return d});void 0!==c.$take&&void 0!==c.$skip?d=d.slice(c.$skip,c.$skip+c.$take):void 0!==c.$take&&d.length>c.$take?d=d.slice(0,c.$take):c.$skip&&(d=d.slice(c.$skip,d.length));c.$some&&(d=[0<d.length]);c.$length&&(d=[d.length]);a.rawDataList=d;b.success(a)},_compile:function(a){return(new $data.storageProviders.InMemory.InMemoryCompiler(this)).compile(a)},
saveChanges:function(a,b){for(var c=0;c<b.length;c++){var e=b[c];switch(e.data.entityState){case $data.EntityState.Added:this._save_add_processPk(e);this.dataSource[e.entitySet.tableName].push(e.data);break;case $data.EntityState.Deleted:var d=this.dataSource[e.entitySet.tableName],g=this._save_getEntity(e,d),e=d.indexOf(g);d.splice(e,1);break;case $data.EntityState.Modified:if(e.data.changedProperties&&0<e.data.changedProperties.length){d=this.dataSource[e.entitySet.tableName];g=this._save_getEntity(e,
d);for(d=0;d<e.data.changedProperties.length;d++){var i=e.data.changedProperties[d];!i.key&&-1<e.entitySet.elementType.memberDefinitions.getPublicMappedPropertyNames().indexOf(i.name)&&(g[i.name]=e.data[i.name])}}}}if(this.providerConfiguration.persistentData&&window.localStorage){var e=this.providerConfiguration.databaseName||"JayData_InMemory_Provider",f=this,j=[];for(c in this.context._entitySetReferences)j.push(this.context._entitySetReferences[c].collectionName);localStorageData=window.localStorage.setItem(e,
JSON.stringify(this.dataSource,function(a,b){if(-1<j.indexOf(a)&&Array.isArray(b)){for(var c=[],d=0;d<b.length;d++){var e={};f.context[a].elementType.memberDefinitions.getPublicMappedProperties().forEach(function(a){if(!a.inverseProperty){var c=Container.resolveName(a.type),c=f.fieldConverter.fromDb[c];e[a.name]=c?c(b[d][a.name]):b[d][a.name]}});c.push(e)}return c}return b}))}a.success()},_save_add_processPk:function(a){var b=a.entitySet.elementType.memberDefinitions.getKeyProperties();if(1===b.length&&
b[0].computed){var b=b[0],c=Container.resolveName(b.type);"function"===typeof this.supportedAutoincrementKeys[c]?a.data[b.name]=this.supportedAutoincrementKeys[c]():!0===this.supportedAutoincrementKeys[c]&&(c=this.dataSource.inmemory_sequence[a.entitySet.tableName],a.data[b.name]=c+1,this.dataSource.inmemory_sequence[a.entitySet.tableName]=c+1)}else for(c=0;c<b.length;c++)(null===a.data[b[c].name]||void 0===a.data[b[c].name])&&Guard.raise(new Exception("Key field must set value! Key field name without value: "+
b[c].name))},_save_getEntity:function(a,b){var c=a.entitySet.elementType.memberDefinitions.getKeyProperties();entities=b.filter(function(b){for(var d=!0,g=0;g<c.length;g++)d=d&&b[c[g].name]===a.data[c[g].name];return d});1<entities&&Guard.raise(new Exception("Inconsistent storage!"));return entities[0]},getTraceString:function(a){return this._compile(a)},supportedDataTypes:{value:[$data.Integer,$data.String,$data.Number,$data.Blob,$data.Boolean,$data.Date,$data.Object,$data.Guid,$data.GeographyPoint,
$data.GeographyLineString,$data.GeographyPolygon,$data.GeographyMultiPoint,$data.GeographyMultiLineString,$data.GeographyMultiPolygon,$data.GeographyCollection,$data.GeometryPoint,$data.GeometryLineString,$data.GeometryPolygon,$data.GeometryMultiPoint,$data.GeometryMultiLineString,$data.GeometryMultiPolygon,$data.GeometryCollection,$data.Byte,$data.SByte,$data.Decimal,$data.Float,$data.Int16,$data.Int32,$data.Int64,$data.Time,$data.DateTimeOffset],writable:!1},supportedBinaryOperators:{value:{equal:{mapTo:" == ",
dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqual:{mapTo:" != ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},equalTyped:{mapTo:" === ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},notEqualTyped:{mapTo:" !== ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThan:{mapTo:" > ",
dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},greaterThanOrEqual:{mapTo:" >= ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThan:{mapTo:" < ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},lessThenOrEqual:{mapTo:" <= ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},or:{mapTo:" || ",
dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},and:{mapTo:" && ",dataType:"boolean",allowedIn:[$data.Expressions.FilterExpression,$data.Expressions.OrderExpression]},"in":{mapTo:".indexOf(",allowedIn:[$data.Expressions.FilterExpression],rightValue:") > -1",reverse:!0}}},supportedUnaryOperators:{value:{not:{mapTo:"!"}}},supportedFieldOperations:{value:{contains:{mapTo:"$data.StringFunctions.contains(",rightValue:")",dataType:"boolean",parameters:[{name:"@expression",
dataType:"string"},{name:"strFragment",dataType:"string"}]},startsWith:{mapTo:"$data.StringFunctions.startsWith(",rightValue:")",dataType:"boolean",parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},endsWith:{mapTo:"$data.StringFunctions.endsWith(",rightValue:")",dataType:"boolean",parameters:[{name:"@expression",dataType:"string"},{name:"strFragment",dataType:"string"}]},length:{dataType:"number",propertyFunction:!0},substr:{mapTo:"substr(",rightValue:")",
dataType:"string",parameters:[{name:"startFrom",dataType:"number"},{name:"length",dataType:"number"}],propertyFunction:!0},toLowerCase:{dataType:"string",mapTo:"toLowerCase()",propertyFunction:!0},toUpperCase:{dataType:"string",mapTo:"toUpperCase()",propertyFunction:!0},trim:{dataType:$data.String,mapTo:"trim()",propertyFunction:!0},ltrim:{dataType:$data.String,mapTo:"trimLeft()",propertyFunction:!0},rtrim:{dataType:$data.String,mapTo:"trimRight()",propertyFunction:!0}},enumerable:!0,writable:!0},
supportedSetOperations:{value:{filter:{},map:{},length:{},forEach:{},toArray:{},single:{},some:{},take:{},skip:{},orderBy:{},orderByDescending:{},first:{}},enumerable:!0,writable:!0},fieldConverter:{value:$data.InMemoryConverter},supportedAutoincrementKeys:{value:{"$data.Integer":!0,"$data.Int32":!0,"$data.Guid":function(){return $data.createGuid()}}}},null);
$C("$data.storageProviders.InMemory.LocalStorageProvider",$data.storageProviders.InMemory.InMemoryProvider,null,{constructor:function(){this.providerConfiguration.persistentData=!0}},null);$data.StorageProviderBase.registerProvider("InMemory",$data.storageProviders.InMemory.InMemoryProvider);$data.StorageProviderBase.registerProvider("LocalStore",$data.storageProviders.InMemory.LocalStorageProvider);
$C("$data.storageProviders.InMemory.InMemoryCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.provider=a},compile:function(a){var b={urlText:""};this.Visit(a.expression,b);var a={},c;for(c in b)0==c.indexOf("$")&&(a[c]=b[c]);return a},VisitOrderExpression:function(a,b){this.Visit(a.source,b);b.data="";b.lambda="";Container.createInMemoryFunctionCompiler(this.provider).compile(a.selector,b);b.$order=b.$order||[];var c=new Function(b.lambda,"return "+b.data+";");
c.ASC="OrderBy"==a.nodeType;b.$order.push(c);b.data="";b.lambda=""},VisitIncludeExpression:function(a,b){this.Visit(a.source,b);b.$include=b.$include||[];0>b.$include.indexOf(a.selector.value)&&b.$include.push(a.selector.value)},VisitPagingExpression:function(a,b){this.Visit(a.source,b);b["$"+a.nodeType.toLowerCase()]=a.amount.value},VisitProjectionExpression:function(a,b){this.defaultFunctionCompiler(a,b,"$map")},VisitFilterExpression:function(a,b){this.defaultFunctionCompiler(a,b,"$filter")},VisitSomeExpression:function(a,
b){this.defaultFunctionCompiler(a,b,"$some")},VisitEveryExpression:function(a,b){this.defaultFunctionCompiler(a,b,"$every")},VisitCountExpression:function(a,b){this.Visit(a.source,b);b.$length=!0},VisitServiceOperationExpression:function(a,b){b.$serviceOperation={name:a.cfg.serviceName,params:a.params}},defaultFunctionCompiler:function(a,b,c){this.Visit(a.source,b);b.data="";b.lambda="";Container.createInMemoryFunctionCompiler(this.provider).compile(a.selector,b);b[c]=new Function(b.lambda,"return "+
b.data+";");b.data="";b.lambda=""}},{});
$C("$data.storageProviders.InMemory.InMemoryFunctionCompiler",$data.Expressions.EntityExpressionVisitor,null,{constructor:function(a){this.provider=a},compile:function(a,b){this.Visit(a,b)},VisitParametricQueryExpression:function(a,b){this.Visit(a.expression,b)},VisitUnaryExpression:function(a,b){b.data+=a.resolution.mapTo;b.data+="(";this.Visit(a.operand,b);b.data+=")"},VisitSimpleBinaryExpression:function(a,b){var c=this;if(a.resolution.reverse){if(b.data+="(","in"===a.resolution.name&&Array.isArray(a.right.value)?
(b.data+="[",a.right.value.forEach(function(a,d){0<d&&(b.data+=",");c.Visit(a,b)}),b.data+="]"):this.Visit(a.right,b),b.data+=a.resolution.mapTo,this.Visit(a.left,b),a.resolution.rightValue)b.data+=a.resolution.rightValue}else b.data+="(",this.Visit(a.left,b),b.data+=a.resolution.mapTo,this.Visit(a.right,b);b.data+=")"},VisitConstantExpression:function(a,b){var c=Container.resolveType(a.type),c=this.provider.fieldConverter.escape[Container.resolveName(c)];b.data+=c?c(a.value):a.value},VisitMemberInfoExpression:function(a,
b){b.data+=".";b.data+=a.memberName},VisitComplexTypeExpression:function(a,b){this.Visit(a.source,b);this.Visit(a.selector,b)},VisitEntityExpression:function(a,b){b.data+=a.selector.lambda;b.lambda=a.selector.lambda;this.Visit(a.source,b)},VisitEntitySetExpression:function(){},VisitObjectLiteralExpression:function(a,b){b.data+="{ ";for(var c=0;c<a.members.length;c++){var e=a.members[c];0<c&&(b.data+=", ");this.Visit(e,b)}b.data+=" }"},VisitObjectFieldExpression:function(a,b){b.data+=a.fieldName+": ";
this.Visit(a.expression,b)},VisitEntityFieldOperationExpression:function(a,b){Guard.requireType("expression.operation",a.operation,$data.Expressions.MemberInfoExpression);var c=a.operation.memberDefinition;c.propertyFunction&&(this.Visit(a.source,b),b.data+=".");b.data+=c.mapTo||c.name;var e=0;(c.parameters||[]).map(function(b){return b.name==="@expression"?a.source:a.parameters[e++]}).forEach(function(a,c){if(a){if(c>0)b.data=b.data+",";this.Visit(a,b)}},this);b.data+=c.rightValue||""}});
